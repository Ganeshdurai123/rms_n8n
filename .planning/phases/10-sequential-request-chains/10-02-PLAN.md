---
phase: 10-sequential-request-chains
plan: 02
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - client/src/lib/types.ts
  - client/src/components/request/RequestInfo.tsx
  - client/src/components/request/ChainStatusPanel.tsx
  - client/src/components/sheet/SheetTable.tsx
  - client/src/pages/RequestDetailPage.tsx
autonomous: true
requirements:
  - CHAIN-03
  - CHAIN-04

must_haves:
  truths:
    - "User can see chain status on request detail page showing all steps with done/active/pending indicators"
    - "Chain status panel shows chain name, each step's sequence number, title, and status badge"
    - "Sheet view shows a Chain column when at least one request in the list belongs to a chain"
    - "Chain column displays chain name and step position (e.g., 'Step 2/4') for at-a-glance progress"
  artifacts:
    - path: "client/src/components/request/ChainStatusPanel.tsx"
      provides: "Chain status visualization component for request detail"
      contains: "ChainStatusPanel"
    - path: "client/src/lib/types.ts"
      provides: "RequestChain and ChainStep TypeScript types"
      contains: "RequestChain"
    - path: "client/src/components/sheet/SheetTable.tsx"
      provides: "Chain column in sheet view table"
      contains: "chainId"
  key_links:
    - from: "client/src/pages/RequestDetailPage.tsx"
      to: "client/src/components/request/ChainStatusPanel.tsx"
      via: "renders ChainStatusPanel when detail.chain is non-null"
      pattern: "ChainStatusPanel"
    - from: "client/src/components/sheet/SheetTable.tsx"
      to: "client/src/lib/types.ts"
      via: "uses RequestItem.chainId and chainSequence for column rendering"
      pattern: "chainId"
---

<objective>
Add chain status visualization to the request detail page and a chain membership column to the sheet view.

Purpose: Users can see at a glance which requests belong to chains, what position they are in the sequence, and the overall chain progress -- making multi-step workflows visible and trackable.

Output: ChainStatusPanel component on request detail page, Chain column in sheet table.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-sequential-request-chains/10-01-SUMMARY.md

@client/src/lib/types.ts
@client/src/pages/RequestDetailPage.tsx
@client/src/components/request/RequestInfo.tsx
@client/src/components/sheet/SheetTable.tsx
@client/src/pages/SheetViewPage.tsx
@client/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types, ChainStatusPanel component, and request detail integration</name>
  <files>
    client/src/lib/types.ts
    client/src/components/request/ChainStatusPanel.tsx
    client/src/pages/RequestDetailPage.tsx
  </files>
  <action>
    **types.ts**: Add chain-related types:
    - `ChainStep`: { requestId: string | { _id: string; title: string; status: RequestStatus }; sequence: number }
    - `RequestChain`: { _id: string; name: string; programId: string; steps: ChainStep[]; status: 'active' | 'completed'; createdBy: string; createdAt: string; updatedAt: string }
    - Update `RequestDetail` interface to include `chain: RequestChain | null` (the chain context returned by the detail API, null when request is not in a chain)
    - Update `RequestItem` interface to add optional `chainId?: string | { _id: string; name: string }` and `chainSequence?: number` fields (populated in list responses when request belongs to a chain)

    **ChainStatusPanel.tsx**: Create a new component that displays chain progress:
    - Props: `chain: RequestChain`, `currentRequestId: string`
    - Renders a Card with CardHeader showing chain name and overall status badge (active/completed)
    - CardContent shows a vertical step list, each step displaying:
      - Sequence number in a circle (styled based on status)
      - Request title (from populated requestId)
      - Status badge using the same STATUS_VARIANT colors from RequestInfo.tsx
      - Visual connector lines between steps (simple border-left pattern)
    - Step styling based on request status:
      - completed: green circle with checkmark, muted title
      - submitted/in_review/approved: blue circle, bold title (active step)
      - draft: gray circle, dimmed title (pending step)
      - rejected: red circle, strikethrough title
    - Current request highlighted with a subtle background color or left border accent
    - Use existing UI components: Card, CardHeader, CardTitle, CardContent, Badge
    - Use lucide-react icons: Check, Circle, Clock for step indicators
    - Keep component lean (under 120 lines) -- it's a read-only display

    **RequestDetailPage.tsx**: Integrate ChainStatusPanel:
    - Import ChainStatusPanel from '@/components/request/ChainStatusPanel'
    - After the RequestInfo card and before the Tabs section, conditionally render:
      `{detail.chain && <ChainStatusPanel chain={detail.chain} currentRequestId={requestId!} />}`
    - The chain data comes from the detail API response (added in Plan 10-01)
    - No additional API calls needed -- chain context is already in the detail response
  </action>
  <verify>
    Run `cd "D:/Niranjan -n8n/rms_proj/client" && npx tsc --noEmit` -- TypeScript compiles without errors.
    Verify ChainStatusPanel.tsx exists and exports ChainStatusPanel.
    Verify RequestDetailPage.tsx imports and conditionally renders ChainStatusPanel.
    Verify types.ts has RequestChain, ChainStep types, and updated RequestDetail and RequestItem interfaces.
  </verify>
  <done>
    Chain status panel renders on request detail page when the request belongs to a chain. Shows chain name, all steps in order with sequence numbers, titles, and color-coded status badges. Current request is visually highlighted. Steps show done/active/pending state clearly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Chain column in sheet view table</name>
  <files>
    client/src/components/sheet/SheetTable.tsx
  </files>
  <action>
    **SheetTable.tsx**: Add a "Chain" column to the sheet view, following the same conditional rendering pattern used for the Due Date column:

    1. Add a `hasChain` memo: `const hasChain = useMemo(() => requests.some((req) => !!req.chainId), [requests]);`
       This conditionally shows the chain column only when at least one request in the current page has a chainId.

    2. Update `totalColumns` calculation to include `(hasChain ? 1 : 0)`.

    3. In the TableHeader, add the Chain column header AFTER the Due Date column (or after Created At if no Due Date):
       ```
       {hasChain && (
         <TableHead>Chain</TableHead>
       )}
       ```
       Chain column is not sortable (chain names are informational, not a data dimension for sorting).

    4. In each TableRow data cell section, add the Chain cell in the same position:
       ```
       {hasChain && (
         <TableCell>
           {req.chainId ? (
             <div className="flex items-center gap-1.5">
               <Badge variant="outline" className="text-xs whitespace-nowrap">
                 {typeof req.chainId === 'object' ? req.chainId.name : 'Chain'}
               </Badge>
               {req.chainSequence && (
                 <span className="text-xs text-muted-foreground">
                   Step {req.chainSequence}/{/* total steps from chain */}
                 </span>
               )}
             </div>
           ) : (
             '-'
           )}
         </TableCell>
       )}
       ```
       Note: Since the list API populates chainId with { _id, name }, we can show the chain name. For step count, use a simple display of the sequence number. The total steps count is not available in the list response (would require a join), so display just "Step N" format: `Step {req.chainSequence}`.
       Actually, simpler and more practical: display `{chainName} (Step {seq})` as a single line. Example: "Onboarding (Step 2)".
       Revised cell content:
       ```
       {req.chainId ? (
         <span className="text-xs whitespace-nowrap">
           {typeof req.chainId === 'object' ? req.chainId.name : 'Chain'}
           {req.chainSequence != null && (
             <span className="text-muted-foreground ml-1">(Step {req.chainSequence})</span>
           )}
         </span>
       ) : '-'}
       ```

    5. In the loading skeleton section, add the chain column skeleton if applicable (though in loading state we don't know hasChain yet, so skip it -- consistent with Due Date skeleton handling which also doesn't render during loading).

    6. Ensure the request.service.ts list endpoint populates chainId with name. In request.service.ts `getRequests`, add `.populate('chainId', 'name')` to the Request.find() query chain. This is needed for the chain name to appear in the sheet view.
       WAIT -- this file is in Plan 01's scope. Since Plan 01 already modifies request.model.ts to add chainId, the populate needs to happen. Add a note: if Plan 01 did not add .populate('chainId', 'name') to getRequests, add it here. Check the Request.find() in getRequests and add populate if missing.
  </action>
  <verify>
    Run `cd "D:/Niranjan -n8n/rms_proj/client" && npx tsc --noEmit` -- TypeScript compiles without errors.
    Verify SheetTable.tsx has hasChain memo and conditional Chain column rendering.
    Verify chain column shows chain name and step number for chain members, '-' for non-chain requests.
  </verify>
  <done>
    Sheet view shows a "Chain" column when at least one request in the current page belongs to a chain. Column displays chain name with step position (e.g., "Onboarding (Step 2)"). Non-chain requests show '-'. Column is hidden when no requests in the current view belong to chains (no clutter).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd client && npx tsc --noEmit` passes
2. ChainStatusPanel renders chain name, step list with sequence/title/status, and highlights current request
3. RequestDetailPage conditionally renders ChainStatusPanel when detail.chain is non-null
4. SheetTable shows Chain column conditionally (same pattern as Due Date column)
5. Chain column displays chain name and step number for chain members
6. Types are consistent: RequestChain, ChainStep, updated RequestDetail and RequestItem
</verification>

<success_criteria>
- Request detail page shows chain status panel with all steps when request is in a chain
- Each chain step displays sequence number, title, and color-coded status indicator
- Current request is visually highlighted in the chain status panel
- Sheet view shows Chain column when any request on the current page has a chainId
- Chain column displays "{chain name} (Step N)" format
- Non-chain requests show '-' in the chain column
- Chain column is hidden when no chain requests exist in the current view
- TypeScript compiles with zero errors on both server and client
</success_criteria>

<output>
After completion, create `.planning/phases/10-sequential-request-chains/10-02-SUMMARY.md`
</output>

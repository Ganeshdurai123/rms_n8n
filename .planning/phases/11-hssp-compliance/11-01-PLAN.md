---
phase: 11-hssp-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/modules/program/program.model.ts
  - server/src/modules/program/program.schema.ts
  - server/src/modules/program/program.service.ts
  - server/src/modules/program/program.controller.ts
  - server/src/modules/program/program.routes.ts
  - server/src/modules/request/request.service.ts
  - server/src/modules/request/request.controller.ts
  - server/src/modules/request/request.routes.ts
  - server/src/modules/request/import.service.ts
  - server/src/shared/types.ts
autonomous: true
requirements:
  - HSSP-01
  - HSSP-02
  - HSSP-03
  - HSSP-04

must_haves:
  truths:
    - "Dynamic fields support a 'checklist' type storing an array of {label, checked} items"
    - "Programs can have a complianceType field (e.g., 'hssp') that persists via create/update"
    - "API returns aggregated checklist completion stats across all requests in a compliance-tagged program"
    - "Checklist field values are validated at the service layer (array of {label: string, checked: boolean})"
  artifacts:
    - path: "server/src/modules/program/program.model.ts"
      provides: "FIELD_TYPES extended with 'checklist', complianceType field on Program"
      contains: "checklist"
    - path: "server/src/modules/program/program.schema.ts"
      provides: "Zod schemas for checklist field definition (items array) and complianceType"
      contains: "complianceType"
    - path: "server/src/modules/request/request.service.ts"
      provides: "validateFields handles checklist type, computeChecklistCompletion utility"
      contains: "checklist"
    - path: "server/src/modules/request/request.controller.ts"
      provides: "getComplianceReview controller handler"
      contains: "getComplianceReview"
  key_links:
    - from: "server/src/modules/request/request.service.ts"
      to: "server/src/modules/program/program.model.ts"
      via: "validateFields uses IFieldDefinition with checklist type"
      pattern: "case 'checklist'"
    - from: "server/src/modules/request/request.routes.ts"
      to: "server/src/modules/request/request.controller.ts"
      via: "GET /compliance-review route"
      pattern: "compliance-review"
---

<objective>
Add backend support for HSSP compliance: checklist field type, program compliance tagging, and compliance review aggregation API.

Purpose: Enable Health & Safety compliance programs to define checklist-based dynamic fields, tag programs with a compliance type, and provide an aggregation endpoint that computes checklist completion across all requests in a program.

Output: Extended program model with complianceType, extended field type system with 'checklist', validated checklist field storage, and a GET /compliance-review endpoint returning per-request and aggregate completion stats.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

@server/src/modules/program/program.model.ts
@server/src/modules/program/program.schema.ts
@server/src/modules/program/program.service.ts
@server/src/modules/program/program.controller.ts
@server/src/modules/program/program.routes.ts
@server/src/modules/request/request.model.ts
@server/src/modules/request/request.service.ts
@server/src/modules/request/request.schema.ts
@server/src/modules/request/request.controller.ts
@server/src/modules/request/request.routes.ts
@server/src/modules/request/import.service.ts
@server/src/shared/types.ts
@client/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend program model and schemas with checklist field type and complianceType</name>
  <files>
    server/src/modules/program/program.model.ts
    server/src/modules/program/program.schema.ts
    server/src/modules/program/program.service.ts
    server/src/modules/program/program.controller.ts
    server/src/modules/program/program.routes.ts
  </files>
  <action>
**program.model.ts:**
1. Add `'checklist'` to the `FIELD_TYPES` array (after 'checkbox', before 'file_upload').
2. Add an optional `items` field to `IFieldDefinition`: `items?: string[]` -- this is the list of checklist item labels that define the checklist template when the field is created on a program. Only meaningful for `type: 'checklist'`.
3. Add `items` to the `fieldDefinitionSchema` subdocument: `items: { type: [String], default: undefined }` (same pattern as `options` for dropdown).
4. Add `COMPLIANCE_TYPES = ['hssp'] as const` and `type ComplianceType = (typeof COMPLIANCE_TYPES)[number]` near the top of the file (below PROGRAM_STATUSES).
5. Add `complianceType?: ComplianceType` to `IProgramDocument` interface.
6. Add `complianceType` field to the `programSchema`: `{ type: String, enum: { values: COMPLIANCE_TYPES, message: 'Invalid compliance type: {VALUE}' }, default: undefined }`.
7. Export `COMPLIANCE_TYPES` and `ComplianceType`.

**program.schema.ts:**
1. Update `fieldDefinitionSchema` Zod schema: add `items: z.array(z.string().trim().min(1).max(200)).optional()` to the object fields.
2. Add a `.refine()` on `fieldDefinitionSchema` (chain after existing dropdown refine): when `type === 'checklist'`, `items` must be defined with at least 1 item. Message: `'Checklist fields must have at least one item'`, path: `['items']`.
3. Add `complianceType: z.enum(['hssp']).optional()` to `createProgramSchema` object (top-level field alongside name, description, etc.).
4. Add `complianceType: z.enum(['hssp']).nullish()` to `updateProgramSchema` object (nullish so it can be cleared by sending null).
5. Add `complianceType: z.enum(['hssp']).optional()` to `listProgramsQuerySchema` for filtering programs by compliance type.

**program.service.ts:**
No changes needed -- the `createProgram` and `updateProgram` functions pass through data to Mongoose, which will store complianceType from the validated body. The `getPrograms` function already uses `filter` object -- add support for `complianceType` filter:
1. In `getPrograms`, after the existing `query.status` filter block, add: `if (query.complianceType) { filter.complianceType = query.complianceType; }`.

**program.controller.ts and program.routes.ts:**
No changes needed -- existing CRUD endpoints pass through data and the new fields will be included in responses automatically since Mongoose serializes all schema fields.
  </action>
  <verify>
Run `npx tsc --noEmit` from the server directory to confirm TypeScript compilation succeeds with no errors. Verify that the FIELD_TYPES array includes 'checklist' and COMPLIANCE_TYPES is exported.
  </verify>
  <done>
Program model has complianceType optional field with 'hssp' enum. Field definitions support 'checklist' type with 'items' array. Zod schemas validate checklist items (at least 1 required). Program list can be filtered by complianceType. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Checklist field validation, compliance review API endpoint, and CSV export support</name>
  <files>
    server/src/modules/request/request.service.ts
    server/src/modules/request/request.controller.ts
    server/src/modules/request/request.routes.ts
    server/src/modules/request/import.service.ts
    server/src/shared/types.ts
  </files>
  <action>
**request.service.ts -- validateFields update:**
1. In the `validateFields` function's switch statement, add a `case 'checklist':` block:
   - Value must be an array: `if (!Array.isArray(value)) throw new ValidationError(...)`.
   - Each element must be an object with `{ label: string, checked: boolean }`: iterate and validate each item has a string `label` and boolean `checked`. Throw `ValidationError` if any item fails.
   - Do NOT validate that labels match the field definition's `items` array -- users may add/remove items during data entry. The `items` on the definition is the template; the stored value is the actual state.

**request.service.ts -- computeChecklistCompletion utility:**
2. Add a new exported function `computeChecklistCompletion(value: unknown): { total: number; checked: number; percentage: number }`:
   - If value is not an array, return `{ total: 0, checked: 0, percentage: 0 }`.
   - Count total items and checked items. Compute percentage as `Math.round((checked / total) * 100)` (or 0 if total is 0).

**request.service.ts -- getComplianceReview function:**
3. Add a new exported async function `getComplianceReview(programId: string, userId: string, userRole: Role)`:
   - Fetch program via `getProgramById(programId)`.
   - Identify checklist field definitions: `program.fieldDefinitions.filter(fd => fd.type === 'checklist')`.
   - If no checklist fields exist, return `{ checklistFields: [], requests: [], summary: { totalRequests: 0, averageCompletion: 0 } }`.
   - Query all requests for this program using the same access-scoping logic as `getRequests` (client sees own, team_member sees own+assigned, admin/manager sees all). No pagination -- fetch all with `.lean()`.
   - For each request, compute completion for each checklist field using `computeChecklistCompletion`. Build a result array:
     ```
     requests: Array<{
       requestId: string;
       title: string;
       status: string;
       completions: Record<string, { total: number; checked: number; percentage: number }>;
       overallPercentage: number;
     }>
     ```
   - `overallPercentage` is the average of all checklist field percentages for that request.
   - Compute `summary.averageCompletion` as the average of all requests' overallPercentage (0 if no requests).
   - Return `{ checklistFields: checklistFieldDefs.map(f => ({ key: f.key, label: f.label, items: f.items })), requests, summary: { totalRequests: requests.length, averageCompletion } }`.

**request.service.ts -- exportRequestsCsv update:**
4. In the `exportRequestsCsv` function's dynamic field value section, add handling for checklist fields. When a field definition's type is 'checklist', format the value as "X/Y (Z%)" using `computeChecklistCompletion` instead of raw `String(val)`.

**request.controller.ts:**
5. Add `getComplianceReview` controller:
   ```typescript
   export async function getComplianceReview(req: Request, res: Response, next: NextFunction): Promise<void> {
     try {
       const result = await requestService.getComplianceReview(
         req.params.programId as string,
         req.user!._id,
         req.user!.role as Role,
       );
       res.status(200).json(result);
     } catch (err) {
       next(err);
     }
   }
   ```

**request.routes.ts:**
6. Add `GET /compliance-review` route BEFORE `/:requestId` routes (same pattern as /export route placement). Route requires `authenticate` and `authorizeProgram()` middleware (matching existing routes). Import `getComplianceReview` from the controller.

**import.service.ts:**
7. In the `validateRowField` function (or wherever row-level field validation happens for imports), add `case 'checklist':` validation. For imports, checklist values should be accepted as a JSON string representing `Array<{label: string, checked: boolean}>`. Parse with `JSON.parse`, validate structure. If invalid JSON or wrong structure, add row error.

**server/src/shared/types.ts:**
No changes needed unless Role type needs updating (it does not).
  </action>
  <verify>
1. Run `npx tsc --noEmit` from server directory -- must compile with no errors.
2. Verify the compliance-review route is registered by checking request.routes.ts has the GET handler before /:requestId.
3. Verify validateFields handles checklist type by searching for `case 'checklist'` in request.service.ts.
  </verify>
  <done>
Checklist field values validated as Array<{label, checked}> during request create/update. Compliance review endpoint returns per-request and aggregate checklist completion. CSV export formats checklist as "X/Y (Z%)". Import service handles checklist field validation. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd server && npx tsc --noEmit` passes with 0 errors
2. Program model exports COMPLIANCE_TYPES with 'hssp'
3. FIELD_TYPES includes 'checklist'
4. fieldDefinitionSchema Zod validates checklist items required
5. validateFields in request.service.ts has case 'checklist'
6. GET /compliance-review route registered before /:requestId in request.routes.ts
7. computeChecklistCompletion exported from request.service.ts
</verification>

<success_criteria>
- FIELD_TYPES array includes 'checklist' alongside existing types
- Program model has optional complianceType field with 'hssp' enum
- Checklist field definitions require items array (at least 1)
- Request field validation accepts checklist values as [{label, checked}] arrays
- GET /api/v1/programs/:programId/requests/compliance-review returns aggregated completion data
- CSV export formats checklist fields as completion percentages
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/11-hssp-compliance/11-01-SUMMARY.md`
</output>

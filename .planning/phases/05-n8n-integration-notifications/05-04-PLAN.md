---
phase: 05-n8n-integration-notifications
plan: 04
type: execute
wave: 2
depends_on:
  - 05-01
  - 05-02
files_modified:
  - n8n/workflows/email-notification.json
  - n8n/workflows/scheduled-reminder.json
  - n8n/README.md
  - server/src/modules/internal/internal.controller.ts
  - server/src/modules/internal/internal.routes.ts
autonomous: true
requirements:
  - N8N-06
  - N8N-07
  - NOTIF-03

must_haves:
  truths:
    - "n8n workflow JSON template receives webhook events and dispatches emails for status changes, assignments, and comments"
    - "n8n scheduled workflow template calls internal API to check for reminders and dispatches reminder emails"
    - "n8n can create in-app notifications by calling POST /api/v1/internal/notifications"
    - "Email notifications are dispatched by n8n, not the Express backend"
  artifacts:
    - path: "n8n/workflows/email-notification.json"
      provides: "n8n workflow JSON for webhook-triggered email notifications"
      contains: "Webhook"
    - path: "n8n/workflows/scheduled-reminder.json"
      provides: "n8n workflow JSON for scheduled reminder checks"
      contains: "Schedule Trigger"
    - path: "n8n/README.md"
      provides: "Setup instructions for importing workflows into n8n"
    - path: "server/src/modules/internal/internal.controller.ts"
      provides: "Internal notification creation and reminder check endpoints"
      contains: "createNotificationHandler"
  key_links:
    - from: "n8n/workflows/email-notification.json"
      to: "server/src/modules/internal/internal.controller.ts"
      via: "HTTP Request node calling POST /api/v1/internal/notifications"
      pattern: "internal/notifications"
    - from: "n8n/workflows/scheduled-reminder.json"
      to: "server/src/modules/internal/internal.controller.ts"
      via: "HTTP Request node calling GET /api/v1/internal/pending-reminders"
      pattern: "internal/pending-reminders"
---

<objective>
Create n8n workflow JSON templates for email notification dispatch and scheduled reminder checks, plus the internal API endpoints they call back into. This completes the n8n integration loop: Express -> webhook outbox -> n8n -> email + internal API callbacks -> in-app notifications.

Purpose: Moves all email dispatch and scheduled task execution out of Express into n8n (per the architecture's "no nodemailer, no node-cron" principle). Users receive email notifications for key events without any cron jobs or email libraries in the Express process.

Output: Two n8n workflow JSON files, README with import instructions, two new internal API endpoints (create notification, get pending reminders).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-n8n-integration-notifications/05-01-SUMMARY.md
@.planning/phases/05-n8n-integration-notifications/05-02-SUMMARY.md
@server/src/modules/internal/internal.controller.ts
@server/src/modules/internal/internal.routes.ts
@server/src/modules/webhook/webhook.types.ts
@server/src/modules/notification/notification.service.ts
@docker-compose.yml
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Internal API endpoints for n8n callbacks (notifications + reminders)</name>
  <files>
    server/src/modules/internal/internal.controller.ts
    server/src/modules/internal/internal.routes.ts
  </files>
  <action>
    Update the internal API to add two new endpoints that n8n workflows call back into:

    **internal.controller.ts** — Add two new handler functions:

    1. `createNotificationHandler`: Accepts POST body `{ userId: string; type: string; title: string; message: string; programId?: string; requestId?: string; metadata?: Record<string, unknown> }`. Calls `createNotificationFromInternal()` from notification.service.ts. Returns 201 with the created notification. Validates required fields inline (userId, type, title, message). Returns 400 if missing. This is how n8n creates in-app notifications after sending an email (so the user sees both email + bell notification).

    2. `getPendingReminders`: Accepts GET with optional query `?programId=...`. Finds requests that are in status `submitted` or `in_review` and have been in that status for more than a configurable duration (default: 48 hours). Query logic: find Requests where `status in ['submitted', 'in_review']` and `updatedAt < (now - 48 hours)`. Populate `createdBy` and `assignedTo` with `firstName lastName email`. Return array of `{ requestId, title, programId, status, assignedTo: { email, name }, createdBy: { email, name }, staleSince: updatedAt }`. Limit to 100 results. This gives n8n the data it needs to send reminder emails.

    Add imports: `createNotificationFromInternal` from notification.service.ts, `Request` from request.model.ts.

    **internal.routes.ts** — Add two new routes:
    - `POST /notifications` -> createNotificationHandler
    - `GET /pending-reminders` -> getPendingReminders

    Both routes are already protected by the `internalAuth` middleware applied via `router.use()`.
  </action>
  <verify>
    Run `cd server && npx tsc --noEmit` -- TypeScript compiles. Verify internal.routes.ts has 4 routes total: GET /health, POST /socket-emit, POST /notifications, GET /pending-reminders.
  </verify>
  <done>
    Internal API exposes notification creation endpoint for n8n to create in-app notifications after email dispatch. Pending reminders endpoint provides stale request data for n8n to send reminder emails. Both secured by shared-secret auth.
  </done>
</task>

<task type="auto">
  <name>Task 2: n8n workflow JSON templates and setup documentation</name>
  <files>
    n8n/workflows/email-notification.json
    n8n/workflows/scheduled-reminder.json
    n8n/README.md
  </files>
  <action>
    Create `n8n/workflows/` directory and three files:

    **email-notification.json** — n8n workflow template for email notifications (N8N-06, NOTIF-03):
    Create a valid n8n workflow JSON with these nodes:
    1. **Webhook Trigger** node: Listens at path `/webhook/rms-events` for POST requests. Expects JSON body matching `WebhookPayload` shape. Authentication: Header Auth with `x-webhook-secret` matching `N8N_WEBHOOK_SECRET`.
    2. **Switch** node: Routes based on `eventType` field. Three branches:
       - `request.status_changed` -> status change email
       - `request.assigned` -> assignment email
       - `comment.added` -> comment email
       - Default -> no-op (discard non-email events)
    3. **Send Email** nodes (one per branch): Uses n8n's built-in Email Send (SMTP) node. Template placeholders:
       - To: `{{ $json.data.assignedTo?.email || $json.data.createdBy?.email }}`
       - Subject: Branch-specific (e.g., "Request status changed: {{ $json.data.request.title }}")
       - Body: HTML template with event details. Keep simple -- event type, request title, performer name, link to request.
       - SMTP credentials reference: `{{ $credentials.smtp }}` (user configures in n8n).
    4. **HTTP Request** node (after each email send): Calls `POST http://server:5000/api/v1/internal/notifications` with `x-api-key` header to create an in-app notification confirming the email was sent. Body: `{ userId, type, title: "Email sent", message: "Email notification sent for [event]", requestId, programId }`.

    Use valid n8n workflow JSON structure with `nodes[]`, `connections{}`, and `settings{}`. Set `active: false` by default (user activates after configuring SMTP). Use n8n node type identifiers: `n8n-nodes-base.webhook`, `n8n-nodes-base.switch`, `n8n-nodes-base.emailSend`, `n8n-nodes-base.httpRequest`.

    **scheduled-reminder.json** — n8n workflow template for scheduled reminders (N8N-07):
    Create a valid n8n workflow JSON with these nodes:
    1. **Schedule Trigger** node: Runs daily at 09:00 UTC (configurable in n8n UI).
    2. **HTTP Request** node: Calls `GET http://server:5000/api/v1/internal/pending-reminders` with `x-api-key` header.
    3. **IF** node: Check if response array has items (length > 0).
    4. **Split In Batches** node: Process each reminder individually.
    5. **Send Email** node: Sends reminder email to the assignee (or creator if unassigned). Subject: "Reminder: Request '{{ $json.title }}' needs attention". Body: HTML template with request details and link.
    6. **HTTP Request** node: Calls `POST http://server:5000/api/v1/internal/notifications` to create an in-app "reminder" notification for the assignee.

    Set `active: false` by default.

    **n8n/README.md** — Setup instructions:
    - Title: "n8n Workflow Templates for RMS"
    - Section: Prerequisites (n8n running, SMTP credentials configured, INTERNAL_API_KEY set)
    - Section: Importing Workflows (step-by-step: open n8n UI at localhost:5678, go to Workflows > Import, select JSON file, configure credentials, activate)
    - Section: Environment Variables (list N8N_WEBHOOK_BASE_URL, N8N_WEBHOOK_SECRET, INTERNAL_API_KEY and what each does)
    - Section: Workflow Descriptions (brief description of each workflow and what it does)
    - Section: Customization (how to modify email templates, change reminder schedule, add new event types)

    Important: The workflow JSONs are TEMPLATES. They use placeholder credential references that the user must configure in n8n's credential manager. The JSON must be valid and importable into n8n, but will need SMTP credentials configured before activation.
  </action>
  <verify>
    Verify all three files exist: `n8n/workflows/email-notification.json`, `n8n/workflows/scheduled-reminder.json`, `n8n/README.md`. Verify JSON files are valid JSON (parse without error). Verify email-notification.json contains Webhook trigger node and email send nodes. Verify scheduled-reminder.json contains Schedule Trigger node.
  </verify>
  <done>
    n8n workflow templates for email notification dispatch (triggered by webhook events) and scheduled reminder checks (daily cron) are ready for import. Templates use SMTP email send and callback to internal API for in-app notification creation. README provides complete setup instructions. Email dispatch handled entirely by n8n, not Express.
  </done>
</task>

</tasks>

<verification>
1. `cd server && npx tsc --noEmit` passes with zero errors
2. Internal API has 4 endpoints: health, socket-emit, notifications, pending-reminders
3. n8n/workflows/email-notification.json is valid JSON with Webhook trigger + Switch + Email Send + HTTP Request nodes
4. n8n/workflows/scheduled-reminder.json is valid JSON with Schedule Trigger + HTTP Request + Email Send nodes
5. Both workflow JSONs set `active: false` by default
6. n8n/README.md contains import instructions and environment variable documentation
7. getPendingReminders returns requests stale for 48+ hours in submitted/in_review status
</verification>

<success_criteria>
- n8n workflow templates are importable and cover email dispatch for status changes, assignments, and comments
- Scheduled reminder workflow checks for stale requests daily and sends reminder emails
- n8n creates in-app notifications via internal API callback after sending each email
- All email dispatch is handled by n8n (zero nodemailer/SMTP code in Express)
- Express exposes no cron jobs -- all scheduled work delegated to n8n
</success_criteria>

<output>
After completion, create `.planning/phases/05-n8n-integration-notifications/05-04-SUMMARY.md`
</output>

---
phase: 05-n8n-integration-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/modules/webhook/webhookEvent.model.ts
  - server/src/modules/webhook/webhookEvent.schema.ts
  - server/src/modules/webhook/webhook.types.ts
  - server/src/modules/webhook/webhook.service.ts
  - server/src/modules/internal/internal.routes.ts
  - server/src/modules/internal/internal.controller.ts
  - server/src/middleware/internalAuth.ts
  - server/src/app.ts
  - server/src/config/env.ts
autonomous: true
requirements:
  - N8N-02
  - N8N-03
  - N8N-04
  - N8N-05

must_haves:
  truths:
    - "Webhook outbox stores events with pending/sent/failed status and supports retry"
    - "Internal API at /api/v1/internal/ requires INTERNAL_API_KEY shared-secret header and rejects unauthenticated requests"
    - "POST /api/v1/internal/socket-emit pushes typed events to connected clients via Socket.IO"
    - "Typed webhook event catalog defines all payload shapes as single source of truth"
  artifacts:
    - path: "server/src/modules/webhook/webhookEvent.model.ts"
      provides: "WebhookEvent Mongoose model with status enum and retry tracking"
      contains: "model WebhookEvent"
    - path: "server/src/modules/webhook/webhook.types.ts"
      provides: "Typed webhook event catalog with all payload shapes"
      exports: ["WebhookEventType", "WebhookPayload"]
    - path: "server/src/modules/webhook/webhook.service.ts"
      provides: "Outbox enqueue, dispatch, and retry functions"
      exports: ["enqueueWebhookEvent", "processOutbox"]
    - path: "server/src/middleware/internalAuth.ts"
      provides: "Shared-secret authentication middleware for internal API"
      exports: ["internalAuth"]
    - path: "server/src/modules/internal/internal.routes.ts"
      provides: "Internal API routes including socket-emit"
      exports: ["internalRouter"]
  key_links:
    - from: "server/src/modules/internal/internal.controller.ts"
      to: "server/src/config/socket.ts"
      via: "getIO() for socket-emit endpoint"
      pattern: "getIO\\(\\)"
    - from: "server/src/middleware/internalAuth.ts"
      to: "server/src/config/env.ts"
      via: "INTERNAL_API_KEY comparison"
      pattern: "env\\.INTERNAL_API_KEY"
    - from: "server/src/app.ts"
      to: "server/src/modules/internal/internal.routes.ts"
      via: "app.use('/api/v1/internal', internalRouter)"
      pattern: "internalRouter"
---

<objective>
Create the webhook outbox infrastructure, typed webhook event catalog, and internal API with shared-secret auth that n8n uses to call back into Express and push real-time events.

Purpose: Establishes the reliable event delivery backbone (outbox pattern) and the secure internal communication channel between n8n and Express that all subsequent plans depend on.

Output: WebhookEvent model, webhook types/service, internalAuth middleware, internal API routes (health, socket-emit), updated app.ts mounting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/config/env.ts
@server/src/config/socket.ts
@server/src/shared/socketEvents.ts
@server/src/shared/errors.ts
@server/src/app.ts
@server/src/middleware/authenticate.ts
@docker/nginx/default.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Webhook outbox model, typed event catalog, and outbox service</name>
  <files>
    server/src/modules/webhook/webhookEvent.model.ts
    server/src/modules/webhook/webhookEvent.schema.ts
    server/src/modules/webhook/webhook.types.ts
    server/src/modules/webhook/webhook.service.ts
  </files>
  <action>
    Create `server/src/modules/webhook/` directory with four files:

    **webhook.types.ts** — Typed webhook event catalog (N8N-05):
    - Define `WebhookEventType` union type covering all 9 mutation types: `request.created`, `request.updated`, `request.status_changed`, `request.assigned`, `request.field_edited`, `comment.added`, `comment.deleted`, `attachment.uploaded`, `attachment.deleted`. These match the existing AUDIT_ACTIONS from auditLog.model.ts.
    - Define `WebhookPayload` interface: `{ eventType: WebhookEventType; programId: string; requestId: string; data: Record<string, unknown>; performedBy: { userId: string; name: string }; timestamp: string; }`.
    - Export `WEBHOOK_EVENT_TYPES` as `const` array for reuse in schema validation.

    **webhookEvent.model.ts** — Mongoose model for webhook outbox (N8N-02):
    - Define `IWebhookEventDocument` interface extending Document with fields: `eventType` (WebhookEventType enum), `payload` (WebhookPayload as Mixed), `status` ('pending' | 'sent' | 'failed'), `retryCount` (number, default 0), `maxRetries` (number, default 3), `lastError` (string, optional), `sentAt` (Date, optional), `nextRetryAt` (Date, optional).
    - Create schema with timestamps, index on `{ status: 1, nextRetryAt: 1 }` for efficient outbox polling, index on `{ createdAt: 1 }` for TTL cleanup.
    - Export `WebhookEvent` model.

    **webhookEvent.schema.ts** — Zod validation schemas:
    - Define `webhookEventQuerySchema` for listing outbox events (admin debugging): `status` filter (optional enum), `page` (default 1), `limit` (default 20).

    **webhook.service.ts** — Outbox enqueue and dispatch logic:
    - `enqueueWebhookEvent(eventType: WebhookEventType, payload: WebhookPayload): Promise<IWebhookEventDocument>` — Creates a pending outbox entry. Fire-and-forget pattern: catches errors, logs, returns null on failure (matches audit.utils.ts pattern).
    - `processOutbox(): Promise<void>` — Finds all WebhookEvents with `status: 'pending'` OR (`status: 'failed'` AND `retryCount < maxRetries` AND `nextRetryAt <= now`). For each, POSTs to `env.N8N_WEBHOOK_BASE_URL + '/' + eventType` with `{ headers: { 'x-webhook-secret': env.N8N_WEBHOOK_SECRET, 'content-type': 'application/json' }, body: JSON.stringify(payload) }`. On success (2xx): set status='sent', sentAt=now. On failure: increment retryCount, set lastError, set nextRetryAt to now + (retryCount * 30_000) ms exponential backoff, set status='failed'. Use native `fetch` (Node 18+).
    - `startOutboxProcessor(intervalMs = 10_000): NodeJS.Timeout` — Calls `processOutbox()` on interval. Returns interval handle for cleanup. Only starts if `env.N8N_WEBHOOK_BASE_URL` is defined (skip in dev without n8n).
    - `stopOutboxProcessor(handle: NodeJS.Timeout): void` — Clears the interval.

    Important: If `env.N8N_WEBHOOK_BASE_URL` is not set, `enqueueWebhookEvent` should still store the event (for when n8n comes online later) but `processOutbox` should skip dispatching and log a debug message.
  </action>
  <verify>
    Run `cd server && npx tsc --noEmit` -- TypeScript compiles with no errors. Verify all four files exist under `server/src/modules/webhook/`.
  </verify>
  <done>
    WebhookEvent model stores outbox entries with pending/sent/failed status. Typed event catalog defines all 9 webhook event types. Service provides enqueue, process, and interval-based outbox processor. Fire-and-forget pattern matches existing audit utility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Internal API middleware and routes with socket-emit endpoint</name>
  <files>
    server/src/middleware/internalAuth.ts
    server/src/modules/internal/internal.routes.ts
    server/src/modules/internal/internal.controller.ts
    server/src/app.ts
  </files>
  <action>
    **internalAuth.ts** — Shared-secret authentication middleware (N8N-03):
    - Create middleware that reads `x-api-key` header from the request.
    - Compares against `env.INTERNAL_API_KEY` using timing-safe comparison (`crypto.timingSafeEqual` from Node.js `crypto` module — convert both strings to Buffer with `Buffer.from()`, compare lengths first to avoid timing leak on different lengths).
    - On mismatch: return `res.status(401).json({ error: 'Invalid API key' })`.
    - On match: call `next()`.
    - Import `env` from `../../config/env.js`.

    **internal.controller.ts** — Controller functions (N8N-03, N8N-04):
    - `healthCheck`: Returns `{ status: 'ok', service: 'internal-api' }` — simple connectivity test for n8n.
    - `socketEmit`: Accepts POST body `{ event: string, programId: string, payload: Record<string, unknown> }`. Validates event is a valid SocketEventName (import from shared/socketEvents.ts). Uses `getIO()` from config/socket.ts to emit `io.to('program:' + programId).emit(event, payload)`. Returns 200 on success. This lets n8n push real-time updates to clients (e.g., after sending an email, push a "notification sent" event). Wrap in try/catch — if Socket.IO not initialized, return 503.

    **internal.routes.ts** — Express router (N8N-03):
    - Create router with `internalAuth` middleware applied to all routes via `router.use(internalAuth)`.
    - `GET /health` -> healthCheck controller.
    - `POST /socket-emit` -> socketEmit controller.
    - Export `internalRouter`.

    **app.ts** — Mount internal routes:
    - Add import: `import { internalRouter } from './modules/internal/internal.routes.js';`
    - Mount BEFORE the 404 handler: `app.use('/api/v1/internal', internalRouter);`
    - This is safe because nginx blocks `/api/v1/internal/` externally (see default.conf line 14-16). Within Docker network, n8n accesses `http://server:5000/api/v1/internal/` directly.

    Note: Do NOT add Zod validation middleware to internal routes — the internal API is trusted and simple. Input validation is done inline in the controller.
  </action>
  <verify>
    Run `cd server && npx tsc --noEmit` -- TypeScript compiles. Verify that `app.ts` mounts internalRouter before the 404 handler. Verify `internalAuth` uses `crypto.timingSafeEqual`.
  </verify>
  <done>
    Internal API at /api/v1/internal/ requires INTERNAL_API_KEY via x-api-key header with timing-safe comparison. Health endpoint confirms connectivity. Socket-emit endpoint lets n8n push typed events to program rooms. Nginx blocks external access. Routes mounted in app.ts.
  </done>
</task>

</tasks>

<verification>
1. `cd server && npx tsc --noEmit` passes with zero errors
2. All 7 new files exist: webhookEvent.model.ts, webhookEvent.schema.ts, webhook.types.ts, webhook.service.ts, internalAuth.ts, internal.routes.ts, internal.controller.ts
3. app.ts imports and mounts internalRouter at /api/v1/internal
4. WebhookEvent model has status enum ['pending', 'sent', 'failed'] and retryCount field
5. internalAuth middleware uses crypto.timingSafeEqual for timing-safe comparison
6. socketEmit controller calls getIO().to('program:'+programId).emit()
</verification>

<success_criteria>
- Webhook outbox model stores events with pending/sent/failed lifecycle and exponential retry
- Typed webhook event catalog covers all 9 mutation types as single source of truth
- Internal API is secured with shared-secret auth (timing-safe) and blocked by nginx externally
- Socket-emit endpoint allows n8n to push real-time events to program-scoped rooms
- All code compiles with TypeScript strict mode
</success_criteria>

<output>
After completion, create `.planning/phases/05-n8n-integration-notifications/05-01-SUMMARY.md`
</output>

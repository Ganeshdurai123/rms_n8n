---
phase: 07-request-books
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - client/src/pages/ImportWizardPage.tsx
  - client/src/components/import/FileUploadStep.tsx
  - client/src/components/import/ColumnMappingStep.tsx
  - client/src/components/import/ValidationPreviewStep.tsx
  - client/src/components/import/ImportResultStep.tsx
  - client/src/components/ui/progress.tsx
  - client/src/components/ui/scroll-area.tsx
  - client/src/lib/types.ts
  - client/src/App.tsx
autonomous: true
requirements:
  - BOOK-01
  - BOOK-02
  - BOOK-03
  - BOOK-04

must_haves:
  truths:
    - "User can upload an Excel or CSV file from the sheet view page"
    - "After upload, user sees file columns and can map them to program fields"
    - "User sees validation preview with row-level error display before importing"
    - "User can execute batch import and sees success/error summary"
  artifacts:
    - path: "client/src/pages/ImportWizardPage.tsx"
      provides: "Multi-step import wizard page with step state management"
      min_lines: 80
    - path: "client/src/components/import/FileUploadStep.tsx"
      provides: "File upload with drag-and-drop and file type validation"
      min_lines: 40
    - path: "client/src/components/import/ColumnMappingStep.tsx"
      provides: "Column-to-field mapping UI with dropdowns"
      min_lines: 60
    - path: "client/src/components/import/ValidationPreviewStep.tsx"
      provides: "Validation preview table with row-level error display"
      min_lines: 60
    - path: "client/src/components/import/ImportResultStep.tsx"
      provides: "Import result summary with success/error counts"
      min_lines: 30
  key_links:
    - from: "client/src/pages/ImportWizardPage.tsx"
      to: "/api/v1/programs/:programId/requests/import"
      via: "api.post for upload, validate, execute"
      pattern: "api\\.(post|get).*import"
    - from: "client/src/components/import/ColumnMappingStep.tsx"
      to: "client/src/lib/types.ts"
      via: "uses FieldDefinition type for mapping targets"
      pattern: "FieldDefinition"
    - from: "client/src/App.tsx"
      to: "client/src/pages/ImportWizardPage.tsx"
      via: "React Router route definition"
      pattern: "ImportWizardPage"
---

<objective>
Build the complete frontend import wizard: a multi-step page with file upload, column-to-field mapping, validation preview with error display, and batch import execution.

Purpose: Provides the user-facing interface for bulk importing requests from Excel/CSV files into a program, with clear step progression and error visibility before committing.

Output: ImportWizardPage with 4 steps (upload, map, preview, result), supporting shadcn/ui components, route integration, and TypeScript types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-request-books/07-01-SUMMARY.md

@client/src/App.tsx
@client/src/lib/api.ts
@client/src/lib/types.ts
@client/src/lib/auth.tsx
@client/src/pages/SheetViewPage.tsx
@client/src/components/sheet/SheetToolbar.tsx
@client/src/components/ui/button.tsx
@client/src/components/ui/card.tsx
@client/src/components/ui/input.tsx
@client/src/components/ui/select.tsx
@client/src/components/ui/dialog.tsx
@client/src/components/ui/table.tsx
@client/src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import wizard page, file upload step, and column mapping step</name>
  <files>
    client/src/pages/ImportWizardPage.tsx
    client/src/components/import/FileUploadStep.tsx
    client/src/components/import/ColumnMappingStep.tsx
    client/src/components/ui/progress.tsx
    client/src/lib/types.ts
    client/src/App.tsx
  </files>
  <action>
1. Add TypeScript types to `client/src/lib/types.ts`:
   ```typescript
   export interface ImportUploadResult {
     importJobId: string;
     columns: string[];
     sampleRows: Record<string, unknown>[];
     totalRows: number;
   }

   export interface ImportValidationResult {
     importJobId: string;
     totalRows: number;
     validCount: number;
     errorCount: number;
     errors: Array<{ row: number; field: string; message: string }>;
     validRows: Array<{ title: string; description?: string; fields: Record<string, unknown> }>;
   }

   export interface ImportExecuteResult {
     importJobId: string;
     successCount: number;
     errorCount: number;
     totalRows: number;
   }

   export interface ImportJob {
     _id: string;
     programId: string;
     performedBy: string | { _id: string; firstName: string; lastName: string; email: string };
     originalFilename: string;
     status: 'pending' | 'validated' | 'completed' | 'failed';
     totalRows: number;
     successCount: number;
     errorCount: number;
     createdAt: string;
   }
   ```

2. Create `client/src/components/ui/progress.tsx` (shadcn/ui progress component -- create manually, NOT via CLI, per Windows path workaround from Phase 6):
   - Based on @radix-ui/react-progress -- BUT since it's not installed, use a simple HTML-based progress bar instead:
   - A div-based progress bar with Tailwind classes: outer div (h-2, w-full, bg-secondary, rounded-full, overflow-hidden), inner div (h-full, bg-primary, transition-all) with width set by `value` prop as percentage.
   - Props: value (number 0-100), className (optional)
   - Export as Progress component using cn() for class merging.

3. Create `client/src/components/import/FileUploadStep.tsx`:
   - Props: `programId: string`, `onUploadComplete: (result: ImportUploadResult) => void`
   - File input accepting .xlsx, .xls, .csv files (accept attribute)
   - Drag-and-drop zone using onDragOver/onDrop events on a styled div:
     - Border-dashed, rounded, p-8, text-center
     - Shows Upload icon (lucide-react) and "Drag & drop your file here or click to browse"
     - Accepted formats: .xlsx, .xls, .csv (shown as helper text)
     - Max file size: 10MB (shown as helper text)
   - Hidden file input triggered by click on the drop zone
   - Client-side file validation: check extension (.xlsx, .xls, .csv) and size (<= 10MB) before uploading
   - On file select: create FormData, append file as 'file', POST to `/programs/${programId}/requests/import` via api
   - Show loading spinner during upload with "Parsing file..." text
   - On success: call onUploadComplete with the response data
   - On error: show toast via sonner with error message
   - Show selected file name and size after selection (before upload starts)

4. Create `client/src/components/import/ColumnMappingStep.tsx`:
   - Props: `columns: string[]`, `sampleRows: Record<string, unknown>[]`, `fieldDefinitions: FieldDefinition[]`, `onMappingComplete: (mapping: { columnMapping: Record<string, string>; titleColumn: string; descriptionColumn?: string }) => void`, `onBack: () => void`
   - Layout: two-column display
     - Left column: "File Columns" list showing each column name with a sample value from first row
     - Right column: mapping dropdowns
   - For each file column, show a Select dropdown with options:
     - "(skip this column)" as the default/empty option
     - "Title (required)" -- maps to request title
     - "Description" -- maps to request description
     - Each program field: `${field.label} (${field.type})` with value = field.key
   - Validation: titleColumn must be mapped (show error message if not). A field cannot be mapped to more than one column (disable already-selected options in other dropdowns).
   - "Required fields" indicator: show which program fields are required and whether they've been mapped (green check or red X)
   - Sample data preview: small table showing first 3 rows with the file's column headers
   - "Next" button (calls onMappingComplete) and "Back" button (calls onBack)
   - Use Card component for the mapping form container

5. Create `client/src/pages/ImportWizardPage.tsx`:
   - Route param: programId from useParams
   - Step state management with useState: currentStep (1-4), and data state for each step's output:
     - uploadResult: ImportUploadResult | null
     - validationResult: ImportValidationResult | null
     - importResult: ImportExecuteResult | null
   - Fetch program data on mount (GET /programs/${programId}) to get fieldDefinitions for mapping step
   - Step indicator: horizontal bar showing steps 1-4 with labels: "Upload File", "Map Columns", "Preview & Validate", "Import". Current step highlighted with primary color, completed steps with check icon. Use the Progress component for visual indicator.
   - Step rendering:
     - Step 1: FileUploadStep (on complete: save uploadResult, advance to step 2)
     - Step 2: ColumnMappingStep (on complete: call POST /import/validate with mapping, save validationResult, advance to step 3)
     - Step 3: ValidationPreviewStep (rendered in Task 2)
     - Step 4: ImportResultStep (rendered in Task 2)
   - "Back to Sheet" link/button in the header area to navigate back to /programs/${programId}/sheet
   - Page title: "Import Requests" with program name subtitle (once loaded)

6. Update `client/src/App.tsx`:
   - Import ImportWizardPage
   - Add route: `<Route path="/programs/:programId/import" element={<ImportWizardPage />} />`
   - Place it inside the ProtectedRoute + AppLayout section alongside the sheet route
  </action>
  <verify>
    - `cd client && npx tsc --noEmit` compiles without errors
    - ImportWizardPage is accessible at /programs/:programId/import route
    - FileUploadStep renders drag-and-drop zone and uploads to correct API endpoint
    - ColumnMappingStep shows all file columns with mapping dropdowns
  </verify>
  <done>
    Import wizard page renders with step indicator, file upload step accepts Excel/CSV files with drag-and-drop and calls the upload API, column mapping step shows all file columns with program field mapping dropdowns and validates title mapping is present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validation preview step, import result step, and sheet view integration</name>
  <files>
    client/src/components/import/ValidationPreviewStep.tsx
    client/src/components/import/ImportResultStep.tsx
    client/src/components/ui/scroll-area.tsx
    client/src/components/sheet/SheetToolbar.tsx
  </files>
  <action>
1. Create `client/src/components/ui/scroll-area.tsx` (create manually per Windows path workaround):
   - Simple scroll area component wrapping children in a div with `overflow-auto max-h-[400px]` Tailwind classes
   - Props: children, className (optional), maxHeight (optional, default '400px')
   - Use cn() for class merging
   - Export as ScrollArea

2. Create `client/src/components/import/ValidationPreviewStep.tsx`:
   - Props: `validationResult: ImportValidationResult`, `onExecuteImport: () => void`, `onBack: () => void`, `isImporting: boolean`
   - Summary section at top:
     - Total rows: {totalRows}
     - Valid rows (ready to import): {validCount} -- shown in green Badge
     - Rows with errors: {errorCount} -- shown in red/destructive Badge (or hidden if 0)
   - If errorCount > 0, show errors section:
     - "Errors" heading with count
     - Scrollable table (using ScrollArea) of errors:
       - Columns: Row #, Field, Error Message
       - Show all errors (up to 100 as returned by API)
       - Each row has a red/orange left border for visual indicator
   - Valid rows preview section:
     - "Preview of valid rows" heading (showing first 5)
     - Table with columns: Title, Description, and mapped field values
     - Uses the standard Table component from shadcn/ui
   - Action buttons at bottom:
     - "Import {validCount} Rows" button (primary, calls onExecuteImport). Disabled when validCount is 0 or isImporting is true. Shows loading spinner when isImporting.
     - "Back" button (secondary, calls onBack)
   - Warning text if errorCount > 0: "Rows with errors will be skipped. Only {validCount} valid rows will be imported."

3. Create `client/src/components/import/ImportResultStep.tsx`:
   - Props: `importResult: ImportExecuteResult`, `programId: string`
   - Success display:
     - Large check icon (lucide-react CheckCircle2) in green if successCount > 0
     - Large X icon (lucide-react XCircle) in red if successCount === 0
     - "Import Complete" heading
     - Summary cards or stats:
       - Total rows processed: {totalRows}
       - Successfully imported: {successCount} (green)
       - Skipped (errors): {errorCount} (red, or hidden if 0)
   - Action buttons:
     - "View in Sheet" -- navigates to /programs/${programId}/sheet (primary)
     - "Import Another File" -- navigates to /programs/${programId}/import (secondary, reloads the wizard)
   - Uses Card component for the result container

4. Update `client/src/components/sheet/SheetToolbar.tsx`:
   - Add an "Import" button next to the existing CSV export button (or in the toolbar actions area)
   - Import button: lucide-react Upload icon + "Import" text
   - On click: navigate to /programs/${programId}/import using useNavigate from react-router-dom
   - The button should be visible to admin and manager roles only (check user role from auth context or pass as prop)
   - Style: secondary variant button, consistent with other toolbar actions

5. Wire up steps 3 and 4 in ImportWizardPage.tsx (update the existing file):
   - Step 3 (ValidationPreviewStep):
     - Pass validationResult from state
     - onExecuteImport: call POST /import/execute with { importJobId: uploadResult.importJobId }, save response as importResult, advance to step 4
     - Track isImporting state for loading indicator
   - Step 4 (ImportResultStep):
     - Pass importResult from state and programId
   - Handle API errors on both validate and execute calls with toast notifications via sonner
  </action>
  <verify>
    - `cd client && npx tsc --noEmit` compiles without errors
    - ValidationPreviewStep correctly renders error table and valid rows preview
    - ImportResultStep shows success/failure summary with navigation links
    - SheetToolbar has Import button that navigates to the import wizard
  </verify>
  <done>
    Validation preview shows row-level errors and valid row preview with batch import button. Import result shows success/error summary with "View in Sheet" navigation. Sheet toolbar has "Import" button linking to the import wizard. Full 4-step wizard flow works end-to-end.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd client && npx tsc --noEmit` passes
2. Navigate to /programs/:programId/import shows the import wizard with step indicator
3. File upload accepts .xlsx/.csv, shows drag-and-drop zone, and calls upload API
4. Column mapping shows file columns with program field mapping dropdowns
5. Validation preview shows row errors and valid row preview
6. Import execution creates requests and shows result summary
7. "Import" button in sheet toolbar navigates to import wizard
8. "View in Sheet" button in result step navigates back to sheet view
</verification>

<success_criteria>
- User can navigate to import wizard from sheet view toolbar
- User can upload Excel/CSV file via drag-and-drop or file picker
- User sees parsed columns and can map them to program fields with dropdown selectors
- User sees validation preview with per-row error display before committing
- User can execute batch import and sees success/error count summary
- User can navigate back to sheet view to see imported requests
</success_criteria>

<output>
After completion, create `.planning/phases/07-request-books/07-02-SUMMARY.md`
</output>

---
phase: 08-client-collaboration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/modules/request/request.service.ts
  - server/src/modules/request/requestDetail.service.ts
  - server/src/modules/request/comment.service.ts
  - server/src/modules/request/attachment.service.ts
  - server/src/modules/request/request.routes.ts
autonomous: true
requirements:
  - CLIENT-01
  - CLIENT-02
  - CLIENT-03
  - CLIENT-04

must_haves:
  truths:
    - "Client can only view detail for requests they created (not other clients' requests in the same program)"
    - "Client can create and submit requests within assigned programs"
    - "Client can add comments and upload/download attachments on their own requests"
    - "Client cannot assign requests, cannot delete others' comments, cannot access import routes"
  artifacts:
    - path: "server/src/modules/request/request.service.ts"
      provides: "Client ownership enforcement on getRequestById and deleteRequest"
      contains: "client.*createdBy"
    - path: "server/src/modules/request/requestDetail.service.ts"
      provides: "Client ownership check on aggregated detail endpoint"
      contains: "ForbiddenError"
    - path: "server/src/modules/request/comment.service.ts"
      provides: "Client can only delete own comments"
      contains: "client.*authorId"
    - path: "server/src/modules/request/attachment.service.ts"
      provides: "Client can only delete own attachments"
      contains: "client.*uploadedBy"
  key_links:
    - from: "server/src/modules/request/requestDetail.service.ts"
      to: "request.createdBy"
      via: "userId comparison for client role"
      pattern: "userRole.*client.*createdBy"
    - from: "server/src/modules/request/request.routes.ts"
      to: "authorizeProgram"
      via: "import routes restricted to manager role"
      pattern: "authorizeProgram.*roles.*manager"
---

<objective>
Harden backend API for client-role access: add ownership enforcement on request detail, single-request get, comment/attachment deletion, and restrict import routes to managers only.

Purpose: The backend already has access-scoped listing (clients see only own requests in getRequests), but individual resource endpoints (getById, getDetail, delete comment/attachment) lack client-specific ownership checks. This plan adds those guards so client users cannot access other users' data even by guessing IDs.

Output: Hardened request detail, comment, and attachment services with client ownership verification; import routes restricted to manager+ roles.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/modules/request/request.service.ts
@server/src/modules/request/requestDetail.service.ts
@server/src/modules/request/comment.service.ts
@server/src/modules/request/attachment.service.ts
@server/src/modules/request/request.routes.ts
@server/src/middleware/authorizeProgram.ts
@server/src/shared/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add client ownership checks to request detail, single get, and delete</name>
  <files>
    server/src/modules/request/request.service.ts
    server/src/modules/request/requestDetail.service.ts
  </files>
  <action>
1. In `requestDetail.service.ts`, update `getRequestDetail` to accept `userId` and `userRole` parameters. After fetching the request, if `userRole === 'client'` and `request.createdBy._id.toString() !== userId`, throw a `ForbiddenError('You can only view your own requests')`. Import `ForbiddenError` from shared/errors.

2. In `request.service.ts`, find the `getRequestById` function. Add `userId` and `userRole` parameters. After fetching the request from cache or DB, if `userRole === 'client'` and `request.createdBy.toString() !== userId`, throw `ForbiddenError('You can only view your own requests')`.

3. In `request.service.ts`, find the `deleteRequest` function. It likely already checks creator ownership. Verify that client role users can only delete their own draft requests. If the check is already there (createdBy === userId), no change needed. If not, add the check.

4. Update `request.controller.ts` to pass `req.user._id` and `req.user.role` to `getRequestDetail` and `getRequestById` calls.

Note: `getRequests` (list) already access-scopes clients to `createdBy: userId` -- no change needed there. The `createRequest` and `transitionRequest` functions also work correctly (creator-only submit rules already in place per Phase 3 decisions). This task is about hardening individual resource access.
  </action>
  <verify>
Run `npx tsc --noEmit` in server/ to confirm no TypeScript errors. Manually trace that getRequestDetail, getRequestById both enforce client ownership.
  </verify>
  <done>
Client role users get 403 Forbidden when trying to access request detail or individual request for a request they did not create. Non-client roles are unaffected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add client guard rails to comments, attachments, and import routes</name>
  <files>
    server/src/modules/request/comment.service.ts
    server/src/modules/request/attachment.service.ts
    server/src/modules/request/request.routes.ts
  </files>
  <action>
1. In `comment.service.ts`, find the `deleteComment` function. Currently it likely allows the comment author or admin to delete. Add a check: if `userRole === 'client'` and the comment's `authorId.toString() !== userId`, throw `ForbiddenError('You can only delete your own comments')`. This ensures clients cannot delete other users' comments on shared requests. Admins and managers retain full delete capability.

2. In `attachment.service.ts`, find the `deleteAttachment` function. Add a similar check: if `userRole === 'client'` and the attachment's `uploadedBy.toString() !== userId`, throw `ForbiddenError('You can only delete your own attachments')`.

3. In `request.routes.ts`, the import sub-routes are mounted at `/import`. Add `authorizeProgram({ roles: ['manager'] })` middleware before the import router mount to restrict import functionality to managers and admins only. Clients and team_members should not access import. The line should become:
   ```
   router.use('/import', authorizeProgram({ roles: ['manager'] }), importRouter);
   ```
   Note: admin already bypasses authorizeProgram so they retain access.

4. Verify the assign endpoint already has `authorizeProgram({ roles: ['manager'] })` -- it does (line 86 of request.routes.ts). No change needed for assign.
  </action>
  <verify>
Run `npx tsc --noEmit` in server/ to confirm no TypeScript errors. Verify import route mount includes the manager role restriction.
  </verify>
  <done>
Client users can only delete their own comments and attachments. Import routes are restricted to manager+ roles. Assign route was already restricted.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in server directory
- requestDetail.service.ts has client ownership check
- request.service.ts getRequestById has client ownership check
- comment.service.ts deleteComment has client ownership check
- attachment.service.ts deleteAttachment has client ownership check
- request.routes.ts import mount includes authorizeProgram roles restriction
- Existing tests (if any) still pass
</verification>

<success_criteria>
- Client role users receive 403 when accessing requests they didn't create via getById or getDetail
- Client role users can only delete their own comments and attachments
- Import routes return 403 for client and team_member roles
- No TypeScript compilation errors
- All existing functionality for admin/manager/team_member roles remains unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-client-collaboration/08-01-SUMMARY.md`
</output>

---
phase: 08-client-collaboration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/pages/RequestDetailPage.tsx
  - client/src/components/request/RequestInfo.tsx
  - client/src/components/request/CommentTimeline.tsx
  - client/src/components/request/AttachmentList.tsx
  - client/src/components/request/AuditTimeline.tsx
  - client/src/components/ui/textarea.tsx
  - client/src/components/ui/tabs.tsx
  - client/src/components/ui/separator.tsx
  - client/src/components/ui/avatar.tsx
  - client/src/lib/types.ts
  - client/src/App.tsx
autonomous: true
requirements:
  - CLIENT-03
  - CLIENT-04

must_haves:
  truths:
    - "User can view a request detail page with all fields, status, assignee, and timestamps"
    - "User can see comments in chronological timeline and add new comments"
    - "User can see file attachments and upload new ones"
    - "User can view audit history of the request"
    - "Navigating from sheet view row opens the request detail page"
  artifacts:
    - path: "client/src/pages/RequestDetailPage.tsx"
      provides: "Full request detail view with tabs for comments, attachments, history"
      min_lines: 80
    - path: "client/src/components/request/CommentTimeline.tsx"
      provides: "Comment list with add-comment form"
      min_lines: 50
    - path: "client/src/components/request/AttachmentList.tsx"
      provides: "Attachment list with upload capability"
      min_lines: 40
    - path: "client/src/components/request/AuditTimeline.tsx"
      provides: "Audit log timeline display"
      min_lines: 30
    - path: "client/src/App.tsx"
      provides: "Route registration for /programs/:programId/requests/:requestId"
      contains: "RequestDetailPage"
  key_links:
    - from: "client/src/pages/RequestDetailPage.tsx"
      to: "/api/v1/programs/:programId/requests/:requestId/detail"
      via: "api.get for aggregated detail"
      pattern: "api\\.get.*detail"
    - from: "client/src/components/request/CommentTimeline.tsx"
      to: "/api/v1/programs/:programId/requests/:requestId/comments"
      via: "api.post for new comment"
      pattern: "api\\.post.*comments"
    - from: "client/src/components/request/AttachmentList.tsx"
      to: "/api/v1/programs/:programId/requests/:requestId/attachments"
      via: "api.post with FormData for file upload"
      pattern: "FormData"
    - from: "client/src/components/sheet/SheetTable.tsx"
      to: "RequestDetailPage"
      via: "Row click navigates to detail page"
      pattern: "navigate.*requests"
---

<objective>
Build the request detail page with comments, attachments, and audit history -- the primary view for clients to interact with their requests.

Purpose: Clients (and all users) need a detail page to view the full state of a request: fields, status, assignee, comment timeline, file attachments, and change history. This page is the core interaction surface for CLIENT-03 (view status and history) and CLIENT-04 (add comments and attachments).

Output: RequestDetailPage with tabbed sections (comments, attachments, history), navigable from sheet view rows.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/modules/request/requestDetail.service.ts
@server/src/modules/request/comment.routes.ts
@server/src/modules/request/attachment.routes.ts
@client/src/lib/types.ts
@client/src/lib/api.ts
@client/src/lib/auth.tsx
@client/src/App.tsx
@client/src/components/sheet/SheetTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create request detail page with request info, comments, attachments, and history tabs</name>
  <files>
    client/src/pages/RequestDetailPage.tsx
    client/src/components/request/RequestInfo.tsx
    client/src/components/request/CommentTimeline.tsx
    client/src/components/request/AttachmentList.tsx
    client/src/components/request/AuditTimeline.tsx
    client/src/lib/types.ts
  </files>
  <action>
1. Add types to `client/src/lib/types.ts`:
   - `Comment` interface: `{ _id: string; requestId: string; authorId: string | { _id: string; firstName: string; lastName: string; email: string }; content: string; createdAt: string; updatedAt: string }`
   - `Attachment` interface: `{ _id: string; requestId: string; uploadedBy: string | { _id: string; firstName: string; lastName: string; email: string }; originalName: string; filename: string; mimeType: string; size: number; createdAt: string }`
   - `AuditEntry` interface: `{ _id: string; action: string; entityType: string; entityId: string; requestId: string; programId: string; performedBy: string | { _id: string; firstName: string; lastName: string; email: string }; before?: Record<string, unknown>; after?: Record<string, unknown>; createdAt: string }`
   - `RequestDetail` interface: `{ request: RequestItem & { programId: { _id: string; name: string; fieldDefinitions: FieldDefinition[] } }; comments: Comment[]; attachments: Attachment[]; auditTrail: AuditEntry[] }`

2. Create `client/src/components/request/RequestInfo.tsx`:
   - Renders the request header: title, status badge, priority badge, assignee, creator, dates
   - Renders dynamic fields based on programId.fieldDefinitions from the populated detail response
   - Uses Card component for layout. Each field rendered as label + value pair.
   - Show status as a colored Badge (reuse same styling as sheet view).

3. Create `client/src/components/request/CommentTimeline.tsx`:
   - Props: `{ comments: Comment[]; programId: string; requestId: string; onCommentAdded: () => void }`
   - Renders comments in chronological order (oldest first, matching backend sort)
   - Each comment: author avatar (first initial), author name, relative time (use simple date formatting), content
   - Add-comment form at bottom: Textarea + "Add Comment" Button
   - On submit: `api.post(\`/programs/\${programId}/requests/\${requestId}/comments\`, { content })`, call `onCommentAdded` callback, clear input, show success toast
   - Handle loading state on submit button

4. Create `client/src/components/request/AttachmentList.tsx`:
   - Props: `{ attachments: Attachment[]; programId: string; requestId: string; onAttachmentAdded: () => void; userId: string; userRole: Role }`
   - Renders attachments as a list: file icon, original name, size (formatted), uploaded by, date
   - Download link: `<a href="/api/v1/programs/${programId}/requests/${requestId}/attachments/${attachmentId}" ...>` -- use api baseURL to construct full path, or use api.get with responseType blob + blob download pattern (matching CSV export pattern from Phase 6)
   - Upload button: hidden file input triggered by Button click
   - On upload: create FormData, append file, `api.post(\`/programs/\${programId}/requests/\${requestId}/attachments\`, formData)`, call callback, show toast
   - Delete button visible only if user is the uploader OR user is admin/manager. Use AlertDialog for confirmation.

5. Create `client/src/components/request/AuditTimeline.tsx`:
   - Props: `{ auditTrail: AuditEntry[] }`
   - Renders audit entries in reverse chronological order (newest first, matching backend sort)
   - Each entry: performer name, action label (humanize: "comment.added" -> "Added a comment", "status.changed" -> "Changed status", "request.updated" -> "Updated request"), relative time
   - For status changes: show from/to if present in before/after
   - Simple vertical timeline layout with left border

6. Create `client/src/pages/RequestDetailPage.tsx`:
   - Route params: `programId` and `requestId` from URL
   - Fetch request detail via `api.get(\`/programs/\${programId}/requests/\${requestId}/detail\`)`
   - Layout: Back button (navigate to sheet view), RequestInfo at top, then tabbed section below
   - Use a simple tab pattern (shadcn Tabs if available, otherwise manual tab state with buttons):
     - "Comments" tab (default): CommentTimeline
     - "Attachments" tab: AttachmentList
     - "History" tab: AuditTimeline
   - `onCommentAdded` and `onAttachmentAdded` callbacks trigger re-fetch of the detail data
   - Loading: Skeleton placeholders
   - Error: error message display

Note: Create shadcn/ui components manually (not via CLI) due to Windows path alias issue found in Phase 06-02:
- `client/src/components/ui/textarea.tsx` -- simple textarea with cn() styling
- `client/src/components/ui/tabs.tsx` -- Tab, TabsList, TabsTrigger, TabsContent using simple div/button state
- `client/src/components/ui/separator.tsx` -- simple hr with Tailwind
- `client/src/components/ui/avatar.tsx` -- simple div-based avatar with initials
  </action>
  <verify>
Run `npx tsc --noEmit` from client/ directory. Verify RequestDetailPage.tsx exists and imports all sub-components. Verify types.ts has Comment, Attachment, AuditEntry, RequestDetail interfaces.
  </verify>
  <done>
RequestDetailPage renders request info, comments with add-comment form, attachments with upload, and audit history. All data fetched from /detail API endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register detail route and add navigation from sheet view</name>
  <files>
    client/src/App.tsx
    client/src/components/sheet/SheetTable.tsx
  </files>
  <action>
1. In `client/src/App.tsx`:
   - Import `RequestDetailPage` from `@/pages/RequestDetailPage`
   - Add route inside the AppLayout protected section: `<Route path="/programs/:programId/requests/:requestId" element={<RequestDetailPage />} />`
   - Place this route AFTER the sheet view route and BEFORE the catch-all redirect

2. In `client/src/components/sheet/SheetTable.tsx`:
   - Add row click navigation. When a user clicks on a table row (not on an action button), navigate to `/programs/${programId}/requests/${request._id}`
   - Use `useNavigate()` from react-router-dom
   - Add `onClick` handler to each `<TableRow>` in the data rows: `onClick={() => navigate(\`/programs/\${programId}/requests/\${row._id}\`)}`
   - Add `cursor-pointer hover:bg-muted/50` classes to clickable rows
   - Ensure action button clicks don't propagate to the row click (add `e.stopPropagation()` on the actions cell or use event delegation)
   - The `programId` prop needs to be passed to SheetTable if not already -- check current props and add if needed

Note: SheetTable needs the programId to construct the navigation URL. Check if it's already available via props or parent context. If not, add it as a prop from SheetViewPage.
  </action>
  <verify>
Run `npx tsc --noEmit` from client/ directory. Verify App.tsx includes the new route. Verify SheetTable has row click navigation.
  </verify>
  <done>
Clicking a row in the sheet view navigates to the request detail page. The /programs/:programId/requests/:requestId route is registered and renders RequestDetailPage.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in client directory
- RequestDetailPage.tsx exists and renders request info, comments, attachments, history
- App.tsx has route for /programs/:programId/requests/:requestId
- SheetTable rows are clickable and navigate to detail page
- CommentTimeline has add-comment form that posts to API
- AttachmentList has upload button that posts FormData to API
- New UI components (textarea, tabs, separator, avatar) created manually
</verification>

<success_criteria>
- Users can navigate from sheet view to request detail by clicking a row
- Request detail page shows all request fields, status, assignee, timestamps
- Users can view and add comments in chronological timeline
- Users can view, upload, and download file attachments
- Users can view audit history of the request
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-client-collaboration/08-02-SUMMARY.md`
</output>

---
phase: 08-client-collaboration
plan: 03
type: execute
wave: 2
depends_on:
  - "08-01"
  - "08-02"
files_modified:
  - client/src/lib/socket.ts
  - client/src/lib/auth.tsx
  - client/src/components/layout/Sidebar.tsx
  - client/src/components/layout/Header.tsx
  - client/src/components/sheet/SheetToolbar.tsx
  - client/src/components/sheet/SheetTable.tsx
  - client/src/components/sheet/SheetRowActions.tsx
  - client/src/pages/SheetViewPage.tsx
  - client/src/pages/RequestDetailPage.tsx
  - client/src/components/request/ActivityFeed.tsx
  - client/package.json
autonomous: true
requirements:
  - CLIENT-01
  - CLIENT-05
  - CLIENT-06

must_haves:
  truths:
    - "Client role users see only their assigned programs in the program list (no other program names visible)"
    - "Client users do not see admin/manager-only UI elements (import buttons, assign actions, member management)"
    - "Client sees an activity feed of updates within their program"
    - "Client receives real-time Socket.IO updates when requests change (sheet refreshes, detail page updates)"
    - "Real-time connection authenticates with JWT and auto-reconnects"
  artifacts:
    - path: "client/src/lib/socket.ts"
      provides: "Socket.IO client connection with JWT auth, auto-reconnect, event listeners"
      min_lines: 40
      exports: ["connectSocket", "disconnectSocket", "useSocket"]
    - path: "client/src/components/request/ActivityFeed.tsx"
      provides: "Program-scoped activity feed showing recent events"
      min_lines: 40
    - path: "client/src/components/layout/Sidebar.tsx"
      provides: "Role-aware navigation hiding admin-only items for clients"
      contains: "user.role"
    - path: "client/src/components/sheet/SheetToolbar.tsx"
      provides: "Import/history buttons hidden for client role"
      contains: "userRole.*client"
  key_links:
    - from: "client/src/lib/socket.ts"
      to: "Socket.IO server"
      via: "socket.io-client with auth.token JWT"
      pattern: "io.*auth.*token"
    - from: "client/src/lib/auth.tsx"
      to: "client/src/lib/socket.ts"
      via: "connectSocket on login, disconnectSocket on logout"
      pattern: "connectSocket|disconnectSocket"
    - from: "client/src/pages/SheetViewPage.tsx"
      to: "client/src/lib/socket.ts"
      via: "useSocket hook for real-time refresh"
      pattern: "useSocket"
    - from: "client/src/pages/RequestDetailPage.tsx"
      to: "client/src/lib/socket.ts"
      via: "useSocket hook for real-time detail updates"
      pattern: "useSocket"
---

<objective>
Add client-aware UI restrictions, Socket.IO real-time integration, and activity feed to complete the client collaboration experience.

Purpose: Client users must see a restricted UI (no import buttons, no assign actions, no admin navigation), must receive real-time updates when their requests change, and must have an activity feed showing recent events in their program. This plan delivers CLIENT-01 (restricted views), CLIENT-05 (activity feed), and CLIENT-06 (real-time updates).

Output: Socket.IO client integration, role-aware UI restrictions throughout the frontend, program activity feed component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-client-collaboration/08-01-SUMMARY.md
@.planning/phases/08-client-collaboration/08-02-SUMMARY.md
@client/src/lib/auth.tsx
@client/src/lib/api.ts
@client/src/components/layout/Sidebar.tsx
@client/src/components/layout/Header.tsx
@client/src/components/sheet/SheetToolbar.tsx
@client/src/components/sheet/SheetTable.tsx
@client/src/components/sheet/SheetRowActions.tsx
@client/src/pages/SheetViewPage.tsx
@client/src/pages/RequestDetailPage.tsx
@server/src/shared/socketEvents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Socket.IO client integration with JWT auth and real-time hooks</name>
  <files>
    client/src/lib/socket.ts
    client/src/lib/auth.tsx
    client/package.json
  </files>
  <action>
1. Install socket.io-client: `cd client && npm install socket.io-client`

2. Create `client/src/lib/socket.ts`:
   - Import `io, Socket` from `socket.io-client`
   - Import `getAccessToken` from `@/lib/api`
   - Module-level variable: `let socket: Socket | null = null`
   - `connectSocket()`: Create socket connection to `window.location.origin` (same host, nginx proxies /socket.io to server). Pass `auth: { token: getAccessToken() }` in connection options. Set `transports: ['websocket', 'polling']`. Add reconnection options: `reconnection: true, reconnectionDelay: 1000, reconnectionAttempts: 10`. Store last event timestamp for catch-up: on each received event, update `lastEventTimestamp`. On reconnect, pass `auth: { token: getAccessToken(), lastEventTimestamp }`. Return the socket instance.
   - `disconnectSocket()`: If socket exists, call `socket.disconnect()`, set `socket = null`.
   - `getSocket()`: Return current socket instance (or null).
   - `useSocket(events: Record<string, (payload: any) => void>)`: Custom React hook that:
     - Takes an object mapping event names to handler functions
     - Uses useEffect to register all event listeners on mount
     - Cleans up listeners on unmount
     - Returns `{ isConnected: boolean }` using socket.connected state with useState
     - Listen for 'connect' and 'disconnect' events to update isConnected

3. In `client/src/lib/auth.tsx`:
   - Import `connectSocket, disconnectSocket` from `@/lib/socket`
   - In the `login` function, after `setUser(data.user)`, call `connectSocket()`
   - In the `logout` function, call `disconnectSocket()` BEFORE the API call (so socket disconnects even if API fails)
   - In the `checkSession` useEffect, after successfully setting user and token, call `connectSocket()` so the socket reconnects on page refresh
   - If checkSession fails (user not logged in), call `disconnectSocket()` to clean up

Note: The Socket.IO server is on the same host behind nginx. The nginx config already proxies WebSocket upgrades. The connection URL should be `window.location.origin` or just use `io()` with no URL (defaults to same origin). Verify nginx config has WebSocket support in docker-compose setup.
  </action>
  <verify>
Run `npx tsc --noEmit` from client/ directory. Verify socket.ts exports connectSocket, disconnectSocket, getSocket, useSocket. Verify auth.tsx calls connectSocket on login/session-check and disconnectSocket on logout.
  </verify>
  <done>
Socket.IO client connects with JWT auth on login/session-restore and disconnects on logout. useSocket hook available for components to subscribe to real-time events.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add client-aware UI restrictions and activity feed</name>
  <files>
    client/src/components/layout/Sidebar.tsx
    client/src/components/sheet/SheetToolbar.tsx
    client/src/components/sheet/SheetRowActions.tsx
    client/src/components/sheet/SheetTable.tsx
    client/src/pages/SheetViewPage.tsx
    client/src/pages/RequestDetailPage.tsx
    client/src/components/request/ActivityFeed.tsx
  </files>
  <action>
1. In `client/src/components/layout/Sidebar.tsx`:
   - The sidebar currently shows "Programs" and "Notifications" links for all users
   - For client role users, keep only "Programs" and "Notifications" (these are appropriate for clients)
   - These are already the only items, so no nav items need hiding
   - No changes needed to Sidebar unless admin-specific items are added later

2. In `client/src/components/sheet/SheetToolbar.tsx`:
   - The `canImport` check already gates import/history buttons to admin/manager
   - Add an additional check: for client role users, also hide the "Assignee" filter dropdown since clients see only their own requests and assignee filtering is not meaningful for them
   - The assignee filter Select is rendered when `programMembers` prop is truthy. Wrap it with: `{userRole !== 'client' && programMembers && ...}`

3. In `client/src/components/sheet/SheetRowActions.tsx`:
   - Check current implementation: it likely shows Edit and Delete actions based on canEdit/canDelete flags
   - These flags should already respect role and ownership (per Phase 06-04 decisions)
   - Verify no admin-only actions are visible to clients. If there's an "Assign" action in the row menu, gate it behind `userRole !== 'client'`
   - If no changes needed, skip this file

4. In `client/src/pages/SheetViewPage.tsx`:
   - Hide the "New Request" (Plus) button only if the program's `settings.allowClientSubmission` is false AND user is client. If allowClientSubmission is true (or user is not client), show the button.
   - Actually, for v1, clients SHOULD be able to create requests (CLIENT-02). So the create button should remain visible for clients. No change needed for the create button.
   - Wire up the `useSocket` hook: import `useSocket` from `@/lib/socket`. Create event handlers for `request:created`, `request:updated`, `request:status_changed`, `request:assigned`, `request:deleted` that call `refresh()` to re-fetch the sheet data. This gives real-time sheet updates.
   - Example: `useSocket({ 'request:created': () => refresh(), 'request:updated': () => refresh(), 'request:status_changed': () => refresh(), 'request:assigned': () => refresh(), 'request:deleted': () => refresh() })`

5. In `client/src/pages/RequestDetailPage.tsx`:
   - Wire up `useSocket` hook for real-time detail updates: listen for `request:updated`, `request:status_changed`, `request:assigned`, `comment:added`, `comment:deleted`, `attachment:uploaded`, `attachment:deleted` events. When any of these fire AND the event's requestId matches the current requestId, re-fetch the detail data.
   - Add the `useSocket` hook with handlers that check `payload.requestId === requestId` before triggering re-fetch
   - For client role users, hide the "Assign" section if it exists in RequestInfo
   - For client role users, hide any "Transition" buttons that the client cannot perform (client can only submit drafts and resubmit rejected). The state machine already enforces this on the backend, but hide the UI buttons too.

6. Create `client/src/components/request/ActivityFeed.tsx`:
   - A component that shows a live stream of recent events in a program
   - Props: `{ programId: string }`
   - Uses `useSocket` to listen for ALL event types (request:created, request:updated, etc.)
   - Maintains a local state array of recent events (max 20, newest first)
   - Each event rendered as: icon (based on event type) + performer name + action description + relative time
   - Event type to human label mapping: request:created -> "created a request", request:status_changed -> "changed status to X", comment:added -> "added a comment", etc.
   - Show on the RequestDetailPage as an optional panel, or integrate into the SheetViewPage as a collapsible sidebar panel
   - For simplicity in v1: render as a small notification-style list in the request detail page below the tabs, showing "Recent activity in this program"
   - Also accessible from SheetViewPage as a small collapsible panel (use a button to toggle visibility)

Note: The activity feed is populated by real-time Socket.IO events. It starts empty on page load and fills as events arrive. For a richer experience, you could pre-populate from the audit API, but for v1 real-time-only is sufficient per the requirement "Client sees activity feed of updates within their program."
  </action>
  <verify>
Run `npx tsc --noEmit` from client/ directory. Verify:
- SheetToolbar hides assignee filter for client role
- SheetViewPage has useSocket hook triggering refresh on events
- RequestDetailPage has useSocket hook for real-time updates
- ActivityFeed component exists and renders recent events
  </verify>
  <done>
Client role users see a restricted UI (no import, no assignee filter). All users get real-time sheet and detail page updates via Socket.IO. Activity feed shows live events within the program.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in client directory
- socket.io-client is installed in client/package.json
- Socket connects on login/session-check, disconnects on logout
- Sheet view auto-refreshes when real-time events arrive
- Request detail page auto-refreshes when events affect the viewed request
- Client role UI hides import buttons and assignee filter
- Activity feed component renders real-time events in human-readable format
- WebSocket connection upgrades work through nginx proxy
</verification>

<success_criteria>
- Client role users see restricted UI (no import, no assignee filter, no admin navigation)
- All users receive real-time updates: sheet view refreshes, detail page updates when events arrive
- Socket.IO connection is authenticated with JWT and auto-reconnects on disconnect
- Activity feed shows recent real-time events within the program
- No TypeScript compilation errors
- Existing functionality for all roles unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-client-collaboration/08-03-SUMMARY.md`
</output>

---
phase: 02-programs-dynamic-fields
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/modules/program/program.model.ts
  - server/src/modules/program/program.schema.ts
  - server/src/modules/program/program.service.ts
  - server/src/modules/program/program.controller.ts
  - server/src/modules/program/program.routes.ts
  - server/src/app.ts
autonomous: true
requirements:
  - PROG-01
  - PROG-02
  - PROG-04
  - PROG-05

must_haves:
  truths:
    - "Admin or manager can create a program with name, description, and settings via POST /api/v1/programs"
    - "Admin or manager can configure dynamic field definitions on a program (text, number, date, dropdown, checkbox, file_upload) and those definitions persist"
    - "Admin or manager can edit a program's name, description, settings, and field definitions via PATCH /api/v1/programs/:programId"
    - "Admin or manager can archive a program via PATCH /api/v1/programs/:programId/archive"
    - "Admin or manager can configure timeframes (startDate, endDate) on a program"
    - "Program GET endpoint returns full program with all field definitions"
  artifacts:
    - path: "server/src/modules/program/program.model.ts"
      provides: "Program Mongoose model with embedded fieldDefinitions, settings, timeframes, status"
      contains: "fieldDefinitions"
    - path: "server/src/modules/program/program.schema.ts"
      provides: "Zod validation schemas for program create, update, field definitions"
      exports: ["createProgramSchema", "updateProgramSchema", "fieldDefinitionSchema"]
    - path: "server/src/modules/program/program.service.ts"
      provides: "Business logic for program CRUD and archiving"
      exports: ["createProgram", "getProgramById", "getPrograms", "updateProgram", "archiveProgram"]
    - path: "server/src/modules/program/program.controller.ts"
      provides: "Thin controller delegating to program service"
    - path: "server/src/modules/program/program.routes.ts"
      provides: "Express routes for program CRUD"
  key_links:
    - from: "server/src/modules/program/program.routes.ts"
      to: "server/src/app.ts"
      via: "app.use('/api/v1/programs', programRouter)"
      pattern: "programRouter"
    - from: "server/src/modules/program/program.controller.ts"
      to: "server/src/modules/program/program.service.ts"
      via: "direct function import"
      pattern: "programService\\."
    - from: "server/src/modules/program/program.routes.ts"
      to: "server/src/middleware/authenticate.ts"
      via: "router.use(authenticate)"
      pattern: "authenticate"
---

<objective>
Create the Program module with Mongoose model, Zod schemas, service layer, controller, and routes for full program CRUD including dynamic field definitions, settings, timeframes, and archiving.

Purpose: Programs are the core organizational unit that define field schemas and boundaries for requests. This plan establishes the data model and CRUD API that all subsequent phases build upon.
Output: Working program CRUD API at /api/v1/programs with embedded dynamic field definitions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md

Key existing patterns to follow:
- Module structure: model.ts, schema.ts, service.ts, controller.ts, routes.ts (see server/src/modules/user/)
- Zod validation: schema.ts exports Zod schemas + inferred types (see server/src/modules/user/user.schema.ts)
- Service layer pattern: controllers never touch models directly (see server/src/modules/user/user.service.ts)
- Router-level middleware: authenticate + authorize applied via router.use() (see server/src/modules/user/user.routes.ts)
- Pagination: paginate() middleware + paginatedResponse() helper (see server/src/middleware/pagination.ts)
- Error classes: NotFoundError, AppError, ForbiddenError, ValidationError (see server/src/shared/errors.ts)
- Cache utilities: cacheGet, cacheSet, cacheInvalidate with CACHE_TTL_CONFIG (see server/src/shared/cache.ts)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Program Mongoose model and Zod validation schemas</name>
  <files>
    server/src/modules/program/program.model.ts
    server/src/modules/program/program.schema.ts
  </files>
  <action>
**Create `server/src/modules/program/program.model.ts`:**

Define the Program Mongoose model following the embedded document pattern from ARCHITECTURE.md Pattern 2.

1. **FieldDefinition sub-schema** (embedded, not a separate collection):
   - `key`: String, required -- machine-readable slug (e.g., "budget_amount"). Must be unique within a program's fieldDefinitions array. Validate with regex: `^[a-z][a-z0-9_]*$` (lowercase, starts with letter, allows underscores/numbers).
   - `label`: String, required -- human-readable display name (e.g., "Budget Amount"). Trimmed, max 100 chars.
   - `type`: String, required, enum: `['text', 'number', 'date', 'dropdown', 'checkbox', 'file_upload']`
   - `required`: Boolean, default false
   - `options`: `[String]` -- only meaningful for `dropdown` type. Each option trimmed, max 200 chars.
   - `placeholder`: String, optional -- hint text for the field input
   - `order`: Number, required -- display order in the form
   - `_id`: false -- suppress Mongoose auto-_id on subdocuments (use `key` as identifier)

2. **Program schema**:
   - `name`: String, required, trimmed, minlength 2, maxlength 100, unique index
   - `description`: String, optional, trimmed, maxlength 2000
   - `fieldDefinitions`: Array of FieldDefinition sub-schema, default empty array
   - `settings`: Mixed subdocument with:
     - `allowClientSubmission`: Boolean, default true -- whether clients can submit requests
     - `requireApproval`: Boolean, default true -- whether requests need manager approval
     - `maxActiveRequests`: Number, optional -- limit on active requests per user (0 = unlimited)
   - `timeframes`: subdocument with:
     - `startDate`: Date, optional -- program accepts submissions from this date
     - `endDate`: Date, optional -- program stops accepting submissions after this date
   - `status`: String, enum: `['active', 'archived']`, default 'active', index
   - `createdBy`: ObjectId, ref 'User', required
   - `timestamps`: true (adds createdAt, updatedAt)

3. **Indexes**:
   - `{ name: 1 }` unique (program names must be unique)
   - `{ status: 1, createdAt: -1 }` (for listing active programs sorted by newest)
   - `{ createdBy: 1 }` (for filtering programs created by a specific user)

4. **Interface exports**:
   - `IFieldDefinition` interface matching the sub-schema fields
   - `IProgramDocument` interface extending Document with all Program fields
   - Export the model as `Program`

**Create `server/src/modules/program/program.schema.ts`:**

Define Zod schemas following the pattern from `server/src/modules/user/user.schema.ts`.

1. **`fieldDefinitionSchema`**: Zod object for a single field definition:
   - `key`: z.string().regex(/^[a-z][a-z0-9_]*$/).max(50)
   - `label`: z.string().min(1).max(100).trim()
   - `type`: z.enum(['text', 'number', 'date', 'dropdown', 'checkbox', 'file_upload'])
   - `required`: z.boolean().default(false)
   - `options`: z.array(z.string().trim().max(200)).optional() -- validate non-empty for dropdown type using `.refine()`: if type is 'dropdown', options must have at least 1 item
   - `placeholder`: z.string().max(200).trim().optional()
   - `order`: z.number().int().min(0)

2. **`createProgramSchema`**: Zod object for POST /programs:
   - `name`: z.string().min(2).max(100).trim()
   - `description`: z.string().max(2000).trim().optional()
   - `fieldDefinitions`: z.array(fieldDefinitionSchema).default([]) -- add `.refine()` to validate unique `key` values within the array
   - `settings`: z.object with allowClientSubmission, requireApproval, maxActiveRequests (all optional with defaults)
   - `timeframes`: z.object with startDate (z.coerce.date().optional()), endDate (z.coerce.date().optional()) -- add `.refine()` to validate endDate > startDate if both present

3. **`updateProgramSchema`**: Same as create but all fields optional (use `.partial()` on relevant fields, but NOT on fieldDefinitions -- when updating fields, send the complete array to avoid merge ambiguity)

4. **`listProgramsQuerySchema`**: Query params:
   - `page`: z.coerce.number().int().min(1).default(1)
   - `limit`: z.coerce.number().int().min(1).max(100).default(20)
   - `status`: z.enum(['active', 'archived']).optional()
   - `search`: z.string().max(100).optional()

5. Export all schemas and their inferred types (CreateProgramInput, UpdateProgramInput, ListProgramsQuery, FieldDefinitionInput).
  </action>
  <verify>
    Run `npx tsc --noEmit` from server/ directory -- should compile clean with no type errors.
    Verify both files exist at the expected paths.
    Verify the fieldDefinitionSchema refine validates that dropdown types require options.
  </verify>
  <done>
    program.model.ts exports Program model and IProgramDocument with embedded fieldDefinitions sub-schema.
    program.schema.ts exports Zod schemas for create, update, list, and field definitions with proper refinements for dropdown options validation and unique keys.
    TypeScript compiles with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Program service, controller, routes, and app.ts mount</name>
  <files>
    server/src/modules/program/program.service.ts
    server/src/modules/program/program.controller.ts
    server/src/modules/program/program.routes.ts
    server/src/app.ts
  </files>
  <action>
**Create `server/src/modules/program/program.service.ts`:**

Follow the pattern from `server/src/modules/user/user.service.ts` -- all business logic here, controllers are thin.

1. **`createProgram(data: CreateProgramInput, userId: string)`**:
   - Check for duplicate program name (case-insensitive: `Program.findOne({ name: { $regex: new RegExp('^' + escapeRegex(data.name) + '$', 'i') } })`)
   - If duplicate, throw `AppError('Program name already exists', 409)`
   - Create and return program (include createdBy: userId)
   - Invalidate program list cache: `cacheInvalidate('programs:list:*')`

2. **`getProgramById(programId: string)`**:
   - Find by ID, if not found throw `NotFoundError('Program not found')`
   - Check cache first: `cacheGet<Program>('programs:${programId}')`, on miss fetch from DB and cache with `CACHE_TTL_CONFIG`
   - Return full program document with fieldDefinitions

3. **`getPrograms(query: ListProgramsQuery)`**:
   - Build filter: status filter, text search on name/description using `$regex` with `$options: 'i'`
   - Paginate with skip/limit, sort by createdAt descending
   - Return `{ programs, total, page, limit }` (same pattern as user.service.ts getUsers)
   - Cache list results with `CACHE_TTL_LIST` (key: `programs:list:${JSON.stringify(query)}`)

4. **`updateProgram(programId: string, data: UpdateProgramInput)`**:
   - Find program, if not found throw NotFoundError
   - If name is being changed, check uniqueness (same case-insensitive check as create)
   - If program is archived, throw `AppError('Cannot update an archived program', 400)`
   - Use `findByIdAndUpdate` with `{ new: true, runValidators: true }`
   - Invalidate caches: both `programs:${programId}` and `programs:list:*`
   - Return updated program

5. **`archiveProgram(programId: string)`**:
   - Find program, if not found throw NotFoundError
   - If already archived, throw `AppError('Program is already archived', 400)`
   - Set status to 'archived'
   - Invalidate caches
   - Return updated program

**Create `server/src/modules/program/program.controller.ts`:**

Thin controllers following the exact pattern from `server/src/modules/user/user.controller.ts` -- try/catch, delegate to service, return appropriate status codes.

1. `createProgram` -- POST, 201, `{ program }`
2. `getPrograms` -- GET, 200, use `paginatedResponse()` helper
3. `getProgramById` -- GET, 200, `{ program }`
4. `updateProgram` -- PATCH, 200, `{ program }`
5. `archiveProgram` -- PATCH, 200, `{ program }`

**Create `server/src/modules/program/program.routes.ts`:**

Follow the pattern from `server/src/modules/user/user.routes.ts`.

1. Apply `authenticate` middleware at router level (all program routes require auth)
2. Apply `authorize('admin', 'manager')` at router level (only admin and manager can manage programs for now -- PROG-06 access-scoped listing is Plan 02)
3. Routes:
   - `POST /` -- validate(createProgramSchema) --> createProgram
   - `GET /` -- validate(listProgramsQuerySchema, 'query'), paginate() --> getPrograms
   - `GET /:programId` --> getProgramById
   - `PATCH /:programId` -- validate(updateProgramSchema) --> updateProgram
   - `PATCH /:programId/archive` --> archiveProgram
4. Export as `programRouter`

**Modify `server/src/app.ts`:**

1. Import `programRouter` from `./modules/program/program.routes.js`
2. Add mount: `app.use('/api/v1/programs', programRouter)` after the userRouter mount (line ~64)
3. Follow the same import pattern -- `.js` extension for ESM compatibility
  </action>
  <verify>
    Run `npx tsc --noEmit` from server/ directory -- should compile clean.
    Verify all 4 files exist at expected paths.
    Verify app.ts has the programRouter mount.
    Verify routes have authenticate + authorize middleware at router level.
  </verify>
  <done>
    Program CRUD API is fully functional at /api/v1/programs with create, list, get, update, and archive endpoints.
    Admin and manager roles can access all program endpoints.
    Dynamic field definitions are configurable via the create and update endpoints (embedded in program document).
    Program timeframes (startDate, endDate) are configurable.
    Programs can be archived (soft state change, not deletion).
    Duplicate program names are rejected (case-insensitive).
    Redis caching applied to program reads with proper invalidation on writes.
    TypeScript compiles with no errors.
  </done>
</task>

</tasks>

<verification>
1. `cd server && npx tsc --noEmit` passes with zero errors
2. All 6 files exist:
   - server/src/modules/program/program.model.ts
   - server/src/modules/program/program.schema.ts
   - server/src/modules/program/program.service.ts
   - server/src/modules/program/program.controller.ts
   - server/src/modules/program/program.routes.ts
   - server/src/app.ts (modified)
3. Program model has fieldDefinitions sub-schema with all 6 field types
4. Zod schema validates dropdown options requirement
5. Routes protected by authenticate + authorize('admin', 'manager')
6. programRouter mounted at /api/v1/programs in app.ts
</verification>

<success_criteria>
- Admin/manager can create a program with name, description, settings, timeframes, and field definitions
- Admin/manager can edit program details and field configuration
- Admin/manager can archive a program
- Dynamic field definitions support all 6 types: text, number, date, dropdown, checkbox, file_upload
- Dropdown fields validate that options array is provided
- Field keys are unique within a program
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-programs-dynamic-fields/02-01-SUMMARY.md`
</output>

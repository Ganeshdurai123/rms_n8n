---
phase: 06-sheet-views
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
  - 06-02
files_modified:
  - client/src/pages/SheetViewPage.tsx
  - client/src/components/sheet/SheetTable.tsx
  - client/src/components/sheet/SheetToolbar.tsx
  - client/src/components/sheet/SheetPagination.tsx
  - client/src/components/sheet/useSheetData.ts
  - client/src/components/ui/table.tsx
  - client/src/components/ui/select.tsx
  - client/src/components/ui/dropdown-menu.tsx
  - client/src/components/ui/popover.tsx
  - client/src/App.tsx
autonomous: true
requirements:
  - SHEET-01
  - SHEET-03
  - SHEET-04
  - SHEET-05
  - SHEET-06

must_haves:
  truths:
    - "User sees requests in a table with columns dynamically generated from the program's field configuration"
    - "User can sort by clicking any column header — ascending/descending toggle"
    - "User can filter by status, assignee, date range, and priority using toolbar controls"
    - "User can type a search keyword and see matching results (title/description)"
    - "User sees pagination controls (page number, total, items per page selector) and can navigate pages"
  artifacts:
    - path: "client/src/pages/SheetViewPage.tsx"
      provides: "Main sheet view page that fetches program config and renders sheet components"
      contains: "SheetViewPage"
    - path: "client/src/components/sheet/SheetTable.tsx"
      provides: "Data table with dynamic columns from program fieldDefinitions, sortable headers"
      contains: "SheetTable"
    - path: "client/src/components/sheet/SheetToolbar.tsx"
      provides: "Filter bar with status, priority, assignee dropdowns, date range, and search input"
      contains: "SheetToolbar"
    - path: "client/src/components/sheet/SheetPagination.tsx"
      provides: "Pagination controls with page nav, total count, and items per page"
      contains: "SheetPagination"
    - path: "client/src/components/sheet/useSheetData.ts"
      provides: "Custom hook managing query state (filters, sort, page) and API fetch"
      contains: "useSheetData"
  key_links:
    - from: "client/src/components/sheet/useSheetData.ts"
      to: "/api/v1/programs/:programId/requests"
      via: "axios GET with query params"
      pattern: "api\\.get.*requests"
    - from: "client/src/pages/SheetViewPage.tsx"
      to: "/api/v1/programs/:programId"
      via: "fetch program config for field definitions"
      pattern: "api\\.get.*programs"
    - from: "client/src/components/sheet/SheetTable.tsx"
      to: "client/src/components/sheet/useSheetData.ts"
      via: "receives data and sort handlers from hook"
      pattern: "onSort"
---

<objective>
Build the sheet view page with a dynamic data table displaying requests in a tabular format, with sorting, filtering, search, and pagination — the primary daily working surface.

Purpose: This is the core deliverable of Phase 6 — a spreadsheet-like interface where users manage requests. The table columns are dynamically generated from the program's field configuration.

Output: Fully functional sheet view with dynamic columns, column sorting, toolbar filters, keyword search, and paginated data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-sheet-views/06-01-SUMMARY.md
@.planning/phases/06-sheet-views/06-02-SUMMARY.md

@client/src/lib/api.ts
@client/src/lib/types.ts
@client/src/lib/auth.tsx
@client/src/App.tsx
@server/src/modules/request/request.schema.ts
@server/src/modules/request/request.model.ts
@server/src/modules/program/program.model.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSheetData hook, SheetTable, SheetToolbar, and SheetPagination components</name>
  <files>
    client/src/components/sheet/useSheetData.ts
    client/src/components/sheet/SheetTable.tsx
    client/src/components/sheet/SheetToolbar.tsx
    client/src/components/sheet/SheetPagination.tsx
    client/src/components/ui/table.tsx
    client/src/components/ui/select.tsx
    client/src/components/ui/dropdown-menu.tsx
    client/src/components/ui/popover.tsx
  </files>
  <action>
    **Add shadcn/ui components (run from client/ directory):**
    ```bash
    npx shadcn@latest add table select dropdown-menu popover -y
    ```
    If shadcn CLI is not available, manually create these component files following shadcn/ui new-york style.

    **client/src/components/sheet/useSheetData.ts — Custom hook for sheet data management:**
    ```typescript
    interface SheetQuery {
      page: number;
      limit: number;
      sortBy: string;
      sortOrder: 'asc' | 'desc';
      status?: string;
      priority?: string;
      assignedTo?: string;
      search?: string;
      createdAfter?: string;
      createdBefore?: string;
    }

    interface UseSheetDataReturn {
      requests: RequestItem[];
      pagination: { page: number; limit: number; total: number; pages: number };
      query: SheetQuery;
      isLoading: boolean;
      error: string | null;
      setPage: (page: number) => void;
      setLimit: (limit: number) => void;
      setSort: (sortBy: string, sortOrder: 'asc' | 'desc') => void;
      toggleSort: (column: string) => void;
      setFilter: (key: string, value: string | undefined) => void;
      setSearch: (search: string) => void;
      setDateRange: (after?: string, before?: string) => void;
      refresh: () => void;
    }
    ```
    - Accept `programId: string` as parameter.
    - Initialize query state with defaults: page=1, limit=20, sortBy='createdAt', sortOrder='desc'.
    - Use useEffect to fetch `GET /api/v1/programs/${programId}/requests` with query params whenever query state changes.
    - Debounce search input by 300ms using a setTimeout/clearTimeout pattern in useEffect.
    - `toggleSort(column)`: if current sortBy === column, toggle sortOrder; else set sortBy=column, sortOrder='asc'. Reset page to 1.
    - `setFilter(key, value)`: update the specific filter key. Reset page to 1 when any filter changes.
    - `refresh()`: re-fetch current query (toggle a refetchCounter state).
    - Return all the above. Export the hook.

    **client/src/components/sheet/SheetTable.tsx — Dynamic data table:**
    Accept props:
    - `requests: RequestItem[]`
    - `fieldDefinitions: FieldDefinition[]` (from program config)
    - `query: SheetQuery` (for current sort indicator)
    - `onToggleSort: (column: string) => void`
    - `onRowClick?: (request: RequestItem) => void` (future use)
    - `isLoading: boolean`
    - `renderRowActions?: (request: RequestItem) => React.ReactNode` (for inline CRUD actions in 06-04)

    Build the table:
    - Use shadcn/ui Table components (Table, TableHeader, TableRow, TableHead, TableBody, TableCell).
    - **Fixed columns** (always shown): Title, Status, Priority, Assigned To, Created By, Created At.
    - **Dynamic columns**: One column per fieldDefinition, sorted by def.order. Use def.label as header text. For each request row, read `request.fields[def.key]` and render appropriately:
      - text/dropdown: display as string
      - number: display formatted number
      - date: display formatted date (YYYY-MM-DD)
      - checkbox: display checkmark icon or dash
      - file_upload: display "File" link or dash
    - **Sort indicators**: Each sortable column header is clickable. Show up/down arrow icon (ChevronUp/ChevronDown from lucide-react) on the currently sorted column. All fixed columns + dynamic text/number/date columns are sortable.
    - **Status column**: Use Badge component with color variants: draft=secondary, submitted=blue, in_review=yellow, approved=green, rejected=red, completed=muted.
    - **Priority column**: Use Badge component with variants: low=secondary, medium=default, high=orange, urgent=destructive.
    - **Assigned To / Created By**: Display "firstName lastName" if populated object, else "Unassigned" or "-".
    - **Created At**: Format as locale date string.
    - **Loading state**: Show skeleton rows (5 rows of skeleton cells) when isLoading.
    - **Empty state**: Show centered "No requests found" message when requests is empty and not loading.
    - **Actions column**: If `renderRowActions` is provided, render it as the last column. Header text: "" (empty). This is for inline edit/delete buttons in 06-04.

    **client/src/components/sheet/SheetToolbar.tsx — Filter and search bar:**
    Accept props:
    - `query: SheetQuery`
    - `onFilterChange: (key: string, value: string | undefined) => void`
    - `onSearchChange: (search: string) => void`
    - `onDateRangeChange: (after?: string, before?: string) => void`
    - `onExport?: () => void` (for CSV export in 06-04)
    - `programMembers?: { _id: string; firstName: string; lastName: string }[]` (for assignee filter)

    Layout: horizontal flex bar above the table with:
    - **Search input**: Text input (placeholder "Search requests...") with Search icon. Controlled value synced to query.search. Calls onSearchChange on change.
    - **Status filter**: Select dropdown with options: All, Draft, Submitted, In Review, Approved, Rejected, Completed. Calls onFilterChange('status', value).
    - **Priority filter**: Select dropdown with options: All, Low, Medium, High, Urgent. Calls onFilterChange('priority', value).
    - **Assignee filter**: Select dropdown populated from programMembers list. Options: All, then each member "firstName lastName" with value _id. Calls onFilterChange('assignedTo', value).
    - **Date range**: Two date inputs (From, To) using native HTML date inputs. Calls onDateRangeChange.
    - **Clear filters button**: Resets all filters to undefined and search to empty.
    - **Export button slot**: If onExport is provided, show a "Export CSV" button with Download icon. (Wired in 06-04.)

    Use shadcn/ui Select for dropdowns, Input for search and date, Button for clear/export.

    **client/src/components/sheet/SheetPagination.tsx — Pagination controls:**
    Accept props:
    - `pagination: { page: number; limit: number; total: number; pages: number }`
    - `onPageChange: (page: number) => void`
    - `onLimitChange: (limit: number) => void`

    Layout: horizontal flex bar below the table with:
    - Left: "Showing X to Y of Z results" text.
    - Center: Page navigation buttons — First, Previous, page number display ("Page N of M"), Next, Last. Disable buttons at boundaries.
    - Right: Items per page selector — Select dropdown with options 10, 20, 50, 100. Calls onLimitChange.
  </action>
  <verify>
    Run `cd client && npx tsc --noEmit` — no type errors. Verify that useSheetData hook correctly builds query params object. Verify SheetTable generates one column per fieldDefinition. Verify SheetToolbar renders filter dropdowns.
  </verify>
  <done>
    useSheetData hook manages all query state and API fetching for the sheet. SheetTable renders dynamic columns from program config with sortable headers. SheetToolbar provides filter/search controls. SheetPagination provides page navigation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SheetViewPage, wire to router, and fetch program config for dynamic columns</name>
  <files>
    client/src/pages/SheetViewPage.tsx
    client/src/App.tsx
  </files>
  <action>
    **client/src/pages/SheetViewPage.tsx — Main sheet view page:**
    - Extract `programId` from URL params via `useParams()`.
    - On mount, fetch the program config from `GET /api/v1/programs/${programId}` to get fieldDefinitions and program name.
    - Optionally fetch program members from `GET /api/v1/programs/${programId}/members` for the assignee filter dropdown (the member list endpoint was created in Phase 2). If the endpoint does not exist or returns 404, gracefully handle by leaving the assignee filter empty.
    - Initialize `useSheetData(programId)` hook.
    - Render the page:
      ```
      <div className="flex flex-col h-full">
        <div className="flex items-center justify-between px-6 py-4 border-b">
          <div>
            <h1 className="text-2xl font-bold">{program.name}</h1>
            <p className="text-muted-foreground">Sheet View - {pagination.total} requests</p>
          </div>
        </div>
        <div className="px-6 py-3">
          <SheetToolbar
            query={query}
            onFilterChange={setFilter}
            onSearchChange={setSearch}
            onDateRangeChange={setDateRange}
            programMembers={members}
          />
        </div>
        <div className="flex-1 overflow-auto px-6">
          <SheetTable
            requests={requests}
            fieldDefinitions={program.fieldDefinitions}
            query={query}
            onToggleSort={toggleSort}
            isLoading={isLoading}
          />
        </div>
        <div className="px-6 py-3 border-t">
          <SheetPagination
            pagination={pagination}
            onPageChange={setPage}
            onLimitChange={setLimit}
          />
        </div>
      </div>
      ```
    - Loading state for program config: Show skeleton while program is loading.
    - Error state: If program fetch fails, show error message with retry button.

    **client/src/App.tsx — Wire sheet view route:**
    Replace the placeholder `<div>Sheet View (coming in 06-03)</div>` with `<SheetViewPage />`:
    ```tsx
    import { SheetViewPage } from '@/pages/SheetViewPage';
    // ...
    <Route path="/programs/:programId/sheet" element={<SheetViewPage />} />
    ```
  </action>
  <verify>
    Run `cd client && npx tsc --noEmit` — no type errors. Run `cd client && npm run build` — builds successfully. Verify that navigating to /programs/:programId/sheet renders the SheetViewPage with table, toolbar, and pagination. Verify that dynamic columns from fieldDefinitions appear in the table header.
  </verify>
  <done>
    SheetViewPage fetches program config and renders dynamic columns in a data table. Sorting, filtering, search, and pagination all work end-to-end via the useSheetData hook and API. The sheet view is the primary working surface accessible at /programs/:programId/sheet.
  </done>
</task>

</tasks>

<verification>
1. `cd client && npx tsc --noEmit` passes
2. `cd client && npm run build` succeeds
3. Navigating to /programs/:programId/sheet shows a table with columns matching the program's fieldDefinitions
4. Clicking a column header sorts the table (ascending/descending toggle with visual indicator)
5. Selecting a status/priority/assignee from the filter dropdowns filters the table
6. Typing in the search input filters results by keyword (with debounce)
7. Setting date range filters requests by creation date
8. Pagination controls navigate between pages and show correct total count
9. Items per page selector (10/20/50/100) works correctly
</verification>

<success_criteria>
- Sheet view renders a tabular interface with dynamic columns from program field configuration
- All standard columns (Title, Status, Priority, Assigned To, Created By, Created At) are always visible
- Dynamic field columns are generated based on the specific program's fieldDefinitions
- Sorting works on any column header click with visual sort indicator
- Toolbar filters (status, priority, assignee, date range) correctly narrow results
- Search input filters by keyword in title/description
- Pagination displays total count, page navigation, and items per page selector
- Loading and empty states are handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/06-sheet-views/06-03-SUMMARY.md`
</output>

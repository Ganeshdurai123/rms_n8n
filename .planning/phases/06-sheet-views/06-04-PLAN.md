---
phase: 06-sheet-views
plan: 04
type: execute
wave: 3
depends_on:
  - 06-03
files_modified:
  - client/src/components/sheet/InlineCreateRow.tsx
  - client/src/components/sheet/InlineEditRow.tsx
  - client/src/components/sheet/SheetRowActions.tsx
  - client/src/components/sheet/SheetTable.tsx
  - client/src/pages/SheetViewPage.tsx
  - client/src/components/ui/dialog.tsx
  - client/src/components/ui/alert-dialog.tsx
autonomous: true
requirements:
  - SHEET-02
  - SHEET-07

must_haves:
  truths:
    - "User can create a new request row inline within the sheet view without navigating away"
    - "User can edit a draft request's fields inline in the sheet view"
    - "User can delete a draft request from the sheet view with a confirmation prompt"
    - "User can export the current filtered view as a CSV file by clicking the export button"
    - "After inline create/edit/delete, the sheet view refreshes to show updated data"
  artifacts:
    - path: "client/src/components/sheet/InlineCreateRow.tsx"
      provides: "Inline form row at top of table for creating new requests"
      contains: "InlineCreateRow"
    - path: "client/src/components/sheet/InlineEditRow.tsx"
      provides: "Inline editable cells for editing a draft request's fields"
      contains: "InlineEditRow"
    - path: "client/src/components/sheet/SheetRowActions.tsx"
      provides: "Row action buttons (edit, delete, status transition) rendered in actions column"
      contains: "SheetRowActions"
  key_links:
    - from: "client/src/components/sheet/InlineCreateRow.tsx"
      to: "/api/v1/programs/:programId/requests"
      via: "POST to create request"
      pattern: "api\\.post.*requests"
    - from: "client/src/components/sheet/InlineEditRow.tsx"
      to: "/api/v1/programs/:programId/requests/:requestId"
      via: "PATCH to update request"
      pattern: "api\\.patch.*requests"
    - from: "client/src/components/sheet/SheetRowActions.tsx"
      to: "/api/v1/programs/:programId/requests/:requestId"
      via: "DELETE to remove request"
      pattern: "api\\.delete.*requests"
    - from: "client/src/pages/SheetViewPage.tsx"
      to: "/api/v1/programs/:programId/requests/export"
      via: "GET with query params to download CSV"
      pattern: "requests/export"
---

<objective>
Add inline CRUD operations (create, edit, delete) and CSV export to the sheet view, completing the full sheet view functionality.

Purpose: Users need to manage requests without leaving the sheet. Inline operations provide the spreadsheet-like experience. CSV export enables data extraction for reporting and sharing.

Output: Inline create/edit/delete rows, row action buttons, confirmation dialogs, and CSV export button — all integrated into the existing sheet view.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-sheet-views/06-01-SUMMARY.md
@.planning/phases/06-sheet-views/06-02-SUMMARY.md
@.planning/phases/06-sheet-views/06-03-SUMMARY.md

@client/src/pages/SheetViewPage.tsx
@client/src/components/sheet/SheetTable.tsx
@client/src/components/sheet/SheetToolbar.tsx
@client/src/components/sheet/useSheetData.ts
@client/src/lib/api.ts
@client/src/lib/types.ts
@server/src/modules/request/request.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create inline create row, inline edit row, and row actions components</name>
  <files>
    client/src/components/sheet/InlineCreateRow.tsx
    client/src/components/sheet/InlineEditRow.tsx
    client/src/components/sheet/SheetRowActions.tsx
    client/src/components/ui/dialog.tsx
    client/src/components/ui/alert-dialog.tsx
  </files>
  <action>
    **Add shadcn/ui components (run from client/ directory):**
    ```bash
    npx shadcn@latest add dialog alert-dialog -y
    ```
    If shadcn CLI is not available, manually create these components following shadcn/ui new-york style.

    **client/src/components/sheet/InlineCreateRow.tsx — Inline create form:**
    Accept props:
    - `programId: string`
    - `fieldDefinitions: FieldDefinition[]`
    - `onCreated: () => void` (callback to refresh sheet data)
    - `onCancel: () => void` (callback to hide create row)

    Render a TableRow at the top of the table body with input cells matching each column:
    - **Title**: Text input (required, min 3 chars).
    - **Status**: Disabled, shows "draft" badge (new requests always start as draft).
    - **Priority**: Select dropdown with low/medium/high/urgent options. Default: medium.
    - **Assigned To**: Empty (assignment is a separate action, not available at creation).
    - **Created By**: Empty/auto (will be the current user).
    - **Created At**: Empty/auto.
    - **Dynamic fields**: Render appropriate input for each fieldDefinition based on type:
      - text: Input type="text"
      - number: Input type="number"
      - date: Input type="date"
      - dropdown: Select with def.options
      - checkbox: Checkbox input
      - file_upload: Skip (file uploads are handled via the attachment API, not inline)
    - **Actions cell**: Save button (check icon) and Cancel button (X icon).

    On save:
    - Validate: title is required (min 3 chars). Show inline validation error if missing.
    - Collect field values from dynamic field inputs into a `fields` Record.
    - POST to `/api/v1/programs/${programId}/requests` with `{ title, description: '', priority, fields, programId }`.
    - On success: show toast "Request created", call onCreated().
    - On error: show toast with error message.
    - Disable save button while submitting (loading state).

    **client/src/components/sheet/InlineEditRow.tsx — Inline edit for draft requests:**
    Accept props:
    - `request: RequestItem`
    - `programId: string`
    - `fieldDefinitions: FieldDefinition[]`
    - `onSaved: () => void` (callback to refresh sheet data)
    - `onCancel: () => void` (callback to exit edit mode)

    Render a TableRow that replaces the normal row with editable inputs:
    - **Title**: Pre-filled text input.
    - **Status**: Disabled, shows current status badge.
    - **Priority**: Select dropdown pre-filled with current priority.
    - **Assigned To**: Disabled (not editable inline).
    - **Created By**: Disabled (not editable).
    - **Created At**: Disabled (not editable).
    - **Dynamic fields**: Same input types as InlineCreateRow, pre-filled with request.fields[def.key] values.
    - **Actions cell**: Save button and Cancel button.

    IMPORTANT: Only draft requests can be edited. The component should only be rendered for draft requests. If the request is not draft, the edit button should not appear (handled in SheetRowActions).

    On save:
    - Collect changed values only (diff against original).
    - PATCH to `/api/v1/programs/${programId}/requests/${request._id}` with changed fields.
    - On success: show toast "Request updated", call onSaved().
    - On error: show toast with error message.

    **client/src/components/sheet/SheetRowActions.tsx — Row action menu:**
    Accept props:
    - `request: RequestItem`
    - `programId: string`
    - `onEdit: () => void` (enter edit mode for this row)
    - `onDeleted: () => void` (refresh sheet after delete)
    - `userRole: Role` (from auth context)
    - `userId: string` (from auth context)

    Render a DropdownMenu (shadcn/ui) with trigger button (MoreHorizontal icon):
    - **Edit** (Pencil icon): Only shown if request.status === 'draft'. Calls onEdit.
    - **Delete** (Trash icon): Only shown if request.status === 'draft' AND (user is creator OR user is admin). Opens AlertDialog for confirmation.

    Delete confirmation dialog:
    - Title: "Delete Request"
    - Description: "Are you sure you want to delete '{request.title}'? This action cannot be undone."
    - Cancel button, Delete button (destructive variant).
    - On confirm: DELETE to `/api/v1/programs/${programId}/requests/${request._id}`. On success: toast "Request deleted", call onDeleted(). On error: toast error.
  </action>
  <verify>
    Run `cd client && npx tsc --noEmit` — no type errors. Verify InlineCreateRow generates input cells for each fieldDefinition type. Verify InlineEditRow pre-fills values from request data. Verify SheetRowActions only shows edit/delete for draft requests.
  </verify>
  <done>
    InlineCreateRow renders a form row for creating requests with dynamic field inputs. InlineEditRow renders editable cells pre-filled with request data. SheetRowActions provides edit/delete actions with confirmation dialog. All actions call the correct API endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate inline CRUD and CSV export into SheetTable and SheetViewPage</name>
  <files>
    client/src/components/sheet/SheetTable.tsx
    client/src/pages/SheetViewPage.tsx
  </files>
  <action>
    **client/src/components/sheet/SheetTable.tsx — Add row actions and edit mode:**
    1. Add state: `editingRowId: string | null` to track which row is in edit mode.
    2. For the actions column (last column), use the `renderRowActions` prop that was already designed in 06-03. If not already wired, add it now: for each row, render `<SheetRowActions>` with an onEdit handler that sets `editingRowId` to the request._id.
    3. When rendering table body rows:
       - If `editingRowId === request._id`, render `<InlineEditRow>` instead of the normal row.
       - Otherwise render the normal data row with SheetRowActions.
    4. Accept new prop `showCreateRow: boolean` and `onCreateDone: () => void`, `onCreateCancel: () => void`.
    5. If `showCreateRow` is true, render `<InlineCreateRow>` as the first row in the table body.
    6. When InlineEditRow's onSaved or onCancel is called, reset editingRowId to null and call the sheet data refresh.
    7. When InlineCreateRow's onCreated or onCancel is called, call the corresponding callbacks.

    **client/src/pages/SheetViewPage.tsx — Add create button and CSV export:**
    1. Add state: `showCreateRow: boolean` (default false).
    2. In the page header area (the div above SheetToolbar), add a "New Request" button (Plus icon). Clicking it sets showCreateRow=true.
    3. Pass `showCreateRow`, `onCreateDone` (sets showCreateRow=false and calls refresh()), and `onCreateCancel` (sets showCreateRow=false) to SheetTable.
    4. Pass `renderRowActions` to SheetTable that renders `<SheetRowActions>` for each row, wired to the edit mode and refresh callbacks.
    5. Wire the CSV export:
       - Add an `onExport` handler to SheetToolbar.
       - The handler: build query params from current query state (same as useSheetData uses, but without page/limit). Call `api.get(/api/v1/programs/${programId}/requests/export, { params, responseType: 'blob' })`. Create a Blob from the response, create a temporary download link, trigger click to download the file, then revoke the URL.
       - Alternatively, since the response is text/csv: use `window.open()` or fetch with the current filter params and trigger download via a hidden <a> element.
    6. Pass user info (useAuth) to SheetTable/SheetRowActions for role-based action visibility (userId and userRole).
  </action>
  <verify>
    Run `cd client && npx tsc --noEmit` — no type errors. Run `cd client && npm run build` — builds successfully. Verify:
    - Clicking "New Request" shows an inline create form row at the top of the table.
    - Saving a new request via the inline form calls POST and refreshes the table.
    - Clicking edit on a draft request shows editable cells for that row.
    - Saving an edited row calls PATCH and refreshes the table.
    - Clicking delete on a draft request shows confirmation, then calls DELETE and refreshes.
    - Clicking "Export CSV" downloads a CSV file with current filters applied.
  </verify>
  <done>
    Sheet view supports full inline CRUD: create new requests, edit draft requests, and delete draft requests — all without leaving the sheet. CSV export downloads the current filtered view. The sheet view is fully functional as the primary daily working surface.
  </done>
</task>

</tasks>

<verification>
1. `cd client && npx tsc --noEmit` passes
2. `cd client && npm run build` succeeds
3. "New Request" button shows inline create form row with dynamic field inputs
4. Inline create form validates required fields and creates request via POST
5. Edit action on draft requests converts row to editable inputs
6. Inline edit saves changes via PATCH and refreshes table
7. Delete action shows confirmation dialog and deletes via DELETE
8. Non-draft requests do not show edit/delete actions
9. CSV export downloads file with current filters applied
10. All CRUD operations show success/error toasts
</verification>

<success_criteria>
- User can create new requests inline (SHEET-02 create)
- User can edit draft request fields inline (SHEET-02 edit)
- User can delete draft requests with confirmation (SHEET-02 delete)
- User can export current filtered view as CSV (SHEET-07)
- Dynamic field inputs match the program's field configuration types
- All mutations refresh the sheet data automatically
- Only draft requests are editable/deletable (enforced both client and server side)
</success_criteria>

<output>
After completion, create `.planning/phases/06-sheet-views/06-04-SUMMARY.md`
</output>

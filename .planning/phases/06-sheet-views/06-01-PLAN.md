---
phase: 06-sheet-views
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/modules/request/request.schema.ts
  - server/src/modules/request/request.service.ts
  - server/src/modules/request/request.controller.ts
  - server/src/modules/request/request.routes.ts
autonomous: true
requirements:
  - SHEET-03
  - SHEET-04
  - SHEET-06
  - SHEET-07

must_haves:
  truths:
    - "GET /api/v1/programs/:programId/requests accepts sortBy and sortOrder query params and returns results sorted accordingly"
    - "GET /api/v1/programs/:programId/requests accepts createdAfter and createdBefore date range filters"
    - "GET /api/v1/programs/:programId/requests correctly paginates with page, limit, and returns total count"
    - "GET /api/v1/programs/:programId/requests/export returns CSV content with dynamic field columns from program config"
    - "DELETE /api/v1/programs/:programId/requests/:requestId deletes a draft request and returns 200"
  artifacts:
    - path: "server/src/modules/request/request.schema.ts"
      provides: "Extended listRequestsQuerySchema with sortBy, sortOrder, createdAfter, createdBefore"
      contains: "sortBy"
    - path: "server/src/modules/request/request.service.ts"
      provides: "Sort, date range filter, CSV export, and delete logic"
      contains: "exportRequestsCsv"
    - path: "server/src/modules/request/request.controller.ts"
      provides: "exportCsv and deleteRequest controller handlers"
      contains: "exportCsv"
    - path: "server/src/modules/request/request.routes.ts"
      provides: "GET /export and DELETE /:requestId routes"
      contains: "export"
  key_links:
    - from: "server/src/modules/request/request.routes.ts"
      to: "server/src/modules/request/request.controller.ts"
      via: "route handler binding"
      pattern: "requestController\\.exportCsv"
    - from: "server/src/modules/request/request.service.ts"
      to: "server/src/modules/program/program.service.ts"
      via: "getProgramById for field definitions in CSV export"
      pattern: "getProgramById"
---

<objective>
Extend the request API with sorting, date range filtering, CSV export, and delete capabilities needed by the sheet view frontend.

Purpose: The sheet view UI requires server-side sort (any column), date range filters, CSV export of filtered results, and inline delete. The existing API supports status/priority/assignee filters and search, but lacks sort control, date range, export, and delete.

Output: Enhanced request list endpoint with sort/date-range params, new CSV export endpoint, new delete endpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@server/src/modules/request/request.schema.ts
@server/src/modules/request/request.service.ts
@server/src/modules/request/request.controller.ts
@server/src/modules/request/request.routes.ts
@server/src/modules/request/request.model.ts
@server/src/modules/program/program.model.ts
@server/src/modules/program/program.service.ts
@server/src/middleware/pagination.ts
@server/src/shared/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sort, date range filter, and delete to request list/service</name>
  <files>
    server/src/modules/request/request.schema.ts
    server/src/modules/request/request.service.ts
  </files>
  <action>
    **request.schema.ts — Extend listRequestsQuerySchema:**
    Add these optional fields to `listRequestsQuerySchema`:
    - `sortBy`: z.enum(['title', 'status', 'priority', 'createdAt', 'updatedAt', 'assignedTo']).default('createdAt') — the column to sort by
    - `sortOrder`: z.enum(['asc', 'desc']).default('desc') — sort direction
    - `createdAfter`: z.coerce.date().optional() — filter requests created on or after this date
    - `createdBefore`: z.coerce.date().optional() — filter requests created on or before this date

    Update the `ListRequestsQuery` type export so it includes the new fields.

    **request.service.ts — Extend getRequests:**
    1. In `getRequests`, after the existing optional filters block:
       - If `query.createdAfter` is provided, add `filter.createdAt = { ...filter.createdAt, $gte: query.createdAfter }` (merge with existing createdAt filter if any)
       - If `query.createdBefore` is provided, add `filter.createdAt = { ...filter.createdAt, $lte: query.createdBefore }`
    2. Replace the hardcoded `.sort({ createdAt: -1 })` with dynamic sort:
       - Build sort object: `{ [query.sortBy || 'createdAt']: query.sortOrder === 'asc' ? 1 : -1 }`
       - Apply to the find query
    3. Ensure the cache key includes sortBy, sortOrder, createdAfter, createdBefore (already included via JSON.stringify(query)).

    **request.service.ts — Add deleteRequest function:**
    Export a new `deleteRequest(requestId: string, userId: string, userRole: Role)` function:
    - Find request by ID. Throw NotFoundError if not found.
    - Only draft requests can be deleted. If status !== 'draft', throw AppError('Only draft requests can be deleted', 400).
    - Only the creator or admin can delete: if userRole !== 'admin' && request.createdBy.toString() !== userId, throw ForbiddenError.
    - Delete the request document: `await Request.findByIdAndDelete(requestId)`.
    - Create audit entry: action 'request.deleted', entityType 'request', with before snapshot.
    - Invalidate caches: `requests:${requestId}` and `requests:list:*`.
    - Emit real-time event 'request:deleted' via fire-and-forget pattern (getPerformerName then emitToProgram + enqueueWebhookEvent).
    - Return the deleted request object (the before snapshot).

    **request.service.ts — Add exportRequestsCsv function:**
    Export a new `exportRequestsCsv(query: ListRequestsQuery, programId: string, userId: string, userRole: Role)` function:
    - Call `getProgramById(programId)` to get program with fieldDefinitions.
    - Reuse the same filter-building logic as `getRequests` (access scoping, status, assignedTo, priority, search, date range) but WITHOUT pagination (no skip/limit) — fetch ALL matching requests.
    - Query with `.lean()` and `.populate('createdBy', 'firstName lastName email').populate('assignedTo', 'firstName lastName email')`.
    - Apply the same sort as getRequests.
    - Build CSV string:
      - Header row: `Title,Description,Status,Priority,Assigned To,Created By,Created At,Updated At` + one column per fieldDefinition (using def.label as header).
      - Data rows: For each request, output values comma-separated. Wrap values containing commas or quotes in double quotes, escaping inner double quotes by doubling them. For populated refs (createdBy, assignedTo), output "firstName lastName". For dynamic fields, get value from request.fields Map using def.key.
    - Return the CSV string.
  </action>
  <verify>
    Run `cd server && npx tsc --noEmit` — no type errors. Manually verify that listRequestsQuerySchema now parses sortBy, sortOrder, createdAfter, createdBefore. Verify deleteRequest and exportRequestsCsv functions are exported.
  </verify>
  <done>
    listRequestsQuerySchema accepts sortBy, sortOrder, createdAfter, createdBefore. getRequests respects sort and date range. deleteRequest deletes draft requests with audit. exportRequestsCsv builds CSV with dynamic field columns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSV export and delete controller endpoints and routes</name>
  <files>
    server/src/modules/request/request.controller.ts
    server/src/modules/request/request.routes.ts
  </files>
  <action>
    **request.controller.ts — Add exportCsv handler:**
    ```
    export async function exportCsv(req, res, next) {
      try {
        const csv = await requestService.exportRequestsCsv(
          req.query as any,
          req.params.programId as string,
          req.user!._id,
          req.user!.role as Role,
        );
        const program = await getProgramById(req.params.programId as string);
        const filename = `${program.name.replace(/[^a-z0-9]/gi, '_')}_requests_${new Date().toISOString().slice(0, 10)}.csv`;
        res.setHeader('Content-Type', 'text/csv');
        res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);
        res.status(200).send(csv);
      } catch (err) {
        next(err);
      }
    }
    ```
    Import `getProgramById` from the program service. Import `exportRequestsCsv` from the request service.

    **request.controller.ts — Add remove handler:**
    ```
    export async function remove(req, res, next) {
      try {
        await requestService.deleteRequest(
          req.params.requestId as string,
          req.user!._id,
          req.user!.role as Role,
        );
        res.status(200).json({ message: 'Request deleted successfully' });
      } catch (err) {
        next(err);
      }
    }
    ```
    Import `deleteRequest` from the request service.

    **request.routes.ts — Add new routes:**
    Add BEFORE the `/:requestId` GET route (to prevent Express misparse):
    - `GET /export` — validates `listRequestsQuerySchema` on query, calls `requestController.exportCsv`
    - `DELETE /:requestId` — validates `requestParamsSchema` on params, calls `requestController.remove`

    Route placement matters: `/export` must come before `/:requestId` in the router to prevent "export" being parsed as a requestId.
  </action>
  <verify>
    Run `cd server && npx tsc --noEmit` — no type errors. Verify the routes file has GET /export before GET /:requestId. Verify DELETE /:requestId route exists.
  </verify>
  <done>
    GET /api/v1/programs/:programId/requests/export returns CSV with Content-Type text/csv. DELETE /api/v1/programs/:programId/requests/:requestId deletes draft requests. Both endpoints are wired through controller to service layer with proper auth middleware.
  </done>
</task>

</tasks>

<verification>
1. `cd server && npx tsc --noEmit` passes with no errors
2. The listRequestsQuerySchema accepts sortBy, sortOrder, createdAfter, createdBefore as optional query params
3. GET /export route is defined before GET /:requestId in request.routes.ts
4. DELETE /:requestId route exists in request.routes.ts
5. exportRequestsCsv generates CSV headers including dynamic field labels from program config
6. deleteRequest only allows deletion of draft requests by creator or admin
</verification>

<success_criteria>
- Server compiles cleanly
- Request list API supports sorting by any standard column via sortBy/sortOrder query params
- Request list API supports date range filtering via createdAfter/createdBefore
- CSV export endpoint returns text/csv with dynamic columns from program field definitions
- Delete endpoint removes draft requests with audit logging and real-time emission
- All existing request API functionality remains unchanged (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/06-sheet-views/06-01-SUMMARY.md`
</output>

---
phase: 09-due-dates-reminders
plan: 02
type: execute
wave: 2
depends_on:
  - 09-01
files_modified:
  - client/src/components/sheet/SheetTable.tsx
  - client/src/components/request/RequestInfo.tsx
  - client/src/pages/CalendarViewPage.tsx
  - client/src/components/calendar/CalendarGrid.tsx
  - client/src/components/calendar/useCalendarData.ts
  - client/src/App.tsx
  - client/src/components/layout/AppLayout.tsx
  - client/src/pages/SheetViewPage.tsx
autonomous: true
requirements:
  - DUE-02
  - DUE-03

must_haves:
  truths:
    - "Sheet view table shows a 'Due Date' column with the request dueDate, and overdue/due-soon requests have colored indicators"
    - "Request detail page shows the due date with overdue/due-soon visual indicators in the info card"
    - "User can navigate to a calendar view page from the sidebar/program page"
    - "Calendar view renders requests on their due dates in a month grid, color-coded by status"
    - "User can switch between month and week views on the calendar"
  artifacts:
    - path: "client/src/components/sheet/SheetTable.tsx"
      provides: "Due Date column with overdue/due-soon badges"
      contains: "dueDate"
    - path: "client/src/components/request/RequestInfo.tsx"
      provides: "Due date display with visual indicators in request detail"
      contains: "dueDate"
    - path: "client/src/pages/CalendarViewPage.tsx"
      provides: "Calendar view page with month/week toggle and request rendering"
      contains: "CalendarViewPage"
    - path: "client/src/components/calendar/CalendarGrid.tsx"
      provides: "Calendar grid component rendering days with request items"
      contains: "CalendarGrid"
    - path: "client/src/components/calendar/useCalendarData.ts"
      provides: "Hook fetching requests by due date range for calendar display"
      contains: "useCalendarData"
    - path: "client/src/App.tsx"
      provides: "Route for calendar view page"
      contains: "calendar"
  key_links:
    - from: "client/src/pages/CalendarViewPage.tsx"
      to: "/api/v1/programs/:programId/requests"
      via: "useCalendarData hook with dueBefore/dueAfter params"
      pattern: "dueBefore|dueAfter"
    - from: "client/src/components/sheet/SheetTable.tsx"
      to: "client/src/lib/types.ts"
      via: "RequestItem.dueDate for column rendering"
      pattern: "request\\.dueDate|req\\.dueDate"
    - from: "client/src/App.tsx"
      to: "client/src/pages/CalendarViewPage.tsx"
      via: "React Router route definition"
      pattern: "CalendarViewPage"
---

<objective>
Add due date visual indicators to the sheet view and request detail page, and build a full calendar view page for deadline planning.

Purpose: Users need to see at a glance which requests are overdue or due soon, and need a calendar-based view for deadline planning across a program.
Output: Due Date column in sheet table, due date display in request detail, calendar view page with month/week views.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-due-dates-reminders/09-01-SUMMARY.md

@client/src/components/sheet/SheetTable.tsx
@client/src/components/request/RequestInfo.tsx
@client/src/pages/SheetViewPage.tsx
@client/src/App.tsx
@client/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Due date column in sheet view + due date display in request detail</name>
  <files>
    client/src/components/sheet/SheetTable.tsx
    client/src/components/request/RequestInfo.tsx
  </files>
  <action>
    1. **SheetTable.tsx** -- Add a "Due Date" column between the existing standard columns (after "Updated At" or "Priority"):
       - Create a `getDueDateIndicator` helper function:
         ```typescript
         function getDueDateIndicator(dueDate?: string): { label: string; className: string } | null {
           if (!dueDate) return null;
           const due = new Date(dueDate);
           const now = new Date();
           const diffMs = due.getTime() - now.getTime();
           const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
           if (diffDays < 0) return { label: `${Math.abs(diffDays)}d overdue`, className: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' };
           if (diffDays <= 3) return { label: `Due in ${diffDays}d`, className: 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300' };
           return null; // No indicator needed for distant due dates
         }
         ```
       - Add a `<TableHead>` for "Due Date" that is sortable (calls `onToggleSort('dueDate')`).
       - In each `<TableRow>`, add a `<TableCell>` that renders: the formatted due date string using `formatDate()`, plus a small `<Badge>` from `getDueDateIndicator` when overdue or due within 3 days.
       - Only render the Due Date column if at least one request in the list has a dueDate value (conditionally show column).

    2. **RequestInfo.tsx** -- Add a due date display to the metadata grid in the info card:
       - After the "Last Updated" grid item, add a "Due Date" item that shows:
         - The formatted due date
         - A colored badge indicator: red for overdue ("X days overdue"), orange for due within 3 days ("Due in X days"), green for on-track ("Due in X days")
       - Only render the due date row if `request.dueDate` is defined (programs without due date config will have no dueDate on requests).
       - Use the same `getDueDateIndicator` logic but include a green variant for the detail page: `{ label: 'Due in Xd', className: 'bg-green-100 text-green-800 ...' }` when > 3 days away.
  </action>
  <verify>
    Run `cd client && npx tsc --noEmit` to confirm no TypeScript errors. Visually verify: the SheetTable has a Due Date column header, and RequestInfo shows a due date field with badge.
  </verify>
  <done>
    Sheet view table displays a sortable "Due Date" column with overdue (red) and due-soon (orange) badge indicators. Request detail info card shows the due date with color-coded status indicator. Both gracefully hide due date UI when dueDate is undefined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Calendar view page with month/week views</name>
  <files>
    client/src/pages/CalendarViewPage.tsx
    client/src/components/calendar/CalendarGrid.tsx
    client/src/components/calendar/useCalendarData.ts
    client/src/App.tsx
    client/src/components/layout/AppLayout.tsx
  </files>
  <action>
    1. **useCalendarData.ts** (`client/src/components/calendar/useCalendarData.ts`) -- Create a custom hook:
       - Accepts `programId`, `viewDate` (Date), `viewMode` ('month' | 'week').
       - Computes date range: for month view, first day of month to last day of month (extend to cover full weeks if needed); for week view, start of week (Monday) to end of week (Sunday).
       - Fetches requests via `api.get('/programs/${programId}/requests', { params: { dueBefore, dueAfter, limit: 200 } })`.
       - Returns `{ requests: RequestItem[], isLoading, error, dateRange: { start: Date, end: Date } }`.
       - Groups requests by due date (YYYY-MM-DD) into a `Map<string, RequestItem[]>` for efficient calendar cell lookup.

    2. **CalendarGrid.tsx** (`client/src/components/calendar/CalendarGrid.tsx`) -- Calendar grid component:
       - Props: `requestsByDate: Map<string, RequestItem[]>`, `dateRange: { start: Date, end: Date }`, `viewMode: 'month' | 'week'`, `onRequestClick: (request: RequestItem) => void`.
       - **Month view**: Render a 7-column grid (Mon-Sun headers). Each day cell shows the day number and up to 3 request items with overflow "+N more" indicator. Each request item shows title truncated to ~20 chars with a small colored dot based on status (use STATUS_VARIANT colors from SheetTable -- reuse pattern).
       - **Week view**: Same 7-column grid but only one row. Each day cell is taller and shows more request details (title + status badge).
       - Today's cell has a distinct border/background (e.g., `ring-2 ring-primary`).
       - Days outside the current month (in month view) are dimmed with `text-muted-foreground opacity-50`.
       - Request items are clickable (calls `onRequestClick`).
       - Status color coding: use small dot/circle before title -- draft=gray, submitted=blue, in_review=yellow, approved=green, rejected=red, completed=gray-muted.

    3. **CalendarViewPage.tsx** (`client/src/pages/CalendarViewPage.tsx`) -- Full page component:
       - Uses `useParams<{ programId: string }>()` to get programId.
       - State: `viewDate` (Date, defaults to today), `viewMode` ('month' | 'week', defaults to 'month').
       - Header: Program name (fetched via `api.get('/programs/${programId}')`), navigation buttons (prev/next month or week, today), view mode toggle (month/week buttons).
       - Passes data to CalendarGrid.
       - When a request is clicked, navigates to `/programs/${programId}/requests/${requestId}`.
       - Navigation: "< Previous" and "Next >" buttons shift viewDate by 1 month or 1 week. "Today" button resets to current date.

    4. **App.tsx** -- Add route for calendar view:
       - Add `import { CalendarViewPage } from '@/pages/CalendarViewPage';`
       - Add route: `<Route path="/programs/:programId/calendar" element={<CalendarViewPage />} />` inside the protected layout routes, after the sheet route.

    5. **AppLayout.tsx** (`client/src/components/layout/AppLayout.tsx`) -- If sidebar navigation exists, add a "Calendar" link next to "Sheet View" for the current program context. If no sidebar program-scoped nav exists, add a "Calendar" button to the SheetViewPage header instead (next to Activity button) by editing `SheetViewPage.tsx` to add a `<Button>` that navigates to `/programs/${programId}/calendar` using the Calendar icon from lucide-react.
       - Decision: Since SheetViewPage already has header buttons, add the Calendar button there. Add `import { Calendar } from 'lucide-react'` and a button: `<Button variant="outline" size="sm" onClick={() => navigate('/programs/' + programId + '/calendar')}><Calendar className="h-4 w-4 mr-1" />Calendar</Button>`.
  </action>
  <verify>
    Run `cd client && npx tsc --noEmit` to confirm no TypeScript errors. Verify App.tsx has the calendar route. Verify CalendarViewPage renders with month/week toggle and navigation controls.
  </verify>
  <done>
    Calendar view page exists at `/programs/:programId/calendar` with month and week view modes. CalendarGrid renders requests on their due dates with status-colored dots. Navigation buttons allow moving between months/weeks. Requests are clickable to navigate to detail page. Calendar button added to SheetViewPage header for easy navigation.
  </done>
</task>

</tasks>

<verification>
- `cd client && npx tsc --noEmit` compiles without errors
- SheetTable shows "Due Date" column with overdue/due-soon badges
- RequestInfo shows due date with color indicators
- CalendarViewPage renders at /programs/:programId/calendar
- Month and week view modes work with navigation controls
- Requests displayed on their due dates in calendar cells
- Calendar button accessible from sheet view page
</verification>

<success_criteria>
Due dates are visible in the sheet view column with overdue/due-soon visual indicators. Request detail page shows due date with color-coded status. Users can navigate to a calendar view that shows requests on their due dates in month and week layouts, color-coded by status.
</success_criteria>

<output>
After completion, create `.planning/phases/09-due-dates-reminders/09-02-SUMMARY.md`
</output>

---
phase: 09-due-dates-reminders
plan: 03
type: execute
wave: 2
depends_on:
  - 09-01
files_modified:
  - server/n8n-workflows/due-date-reminder-workflow.json
  - server/src/modules/notification/notification.model.ts
autonomous: true
requirements:
  - DUE-04

must_haves:
  truths:
    - "n8n workflow JSON template exists that can be imported into n8n"
    - "Workflow uses Schedule Trigger to run daily (configurable)"
    - "Workflow calls GET /api/v1/internal/pending-reminders to fetch overdue and upcoming requests"
    - "Workflow sends reminder emails for each request with due date context (days overdue, due date)"
    - "Workflow creates in-app notifications via POST /api/v1/internal/notifications after sending emails"
  artifacts:
    - path: "server/n8n-workflows/due-date-reminder-workflow.json"
      provides: "Importable n8n workflow for due-date-based reminders"
      contains: "pending-reminders"
  key_links:
    - from: "server/n8n-workflows/due-date-reminder-workflow.json"
      to: "server/src/modules/internal/internal.controller.ts"
      via: "HTTP Request node calling GET /api/v1/internal/pending-reminders"
      pattern: "pending-reminders"
---

<objective>
Create an n8n workflow JSON template for due-date-based reminder notifications. The workflow runs on a schedule, queries the updated pending-reminders internal API for overdue and upcoming requests, sends reminder emails, and creates in-app notifications.

Purpose: Automates reminder delivery so users are notified about approaching and overdue deadlines without any manual monitoring. Replaces the Phase 5 staleness-based reminder workflow with a due-date-aware version.
Output: Importable n8n workflow JSON file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-due-dates-reminders/09-01-SUMMARY.md

@server/src/modules/internal/internal.controller.ts
@server/src/modules/internal/internal.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n due-date reminder workflow JSON</name>
  <files>
    server/n8n-workflows/due-date-reminder-workflow.json
  </files>
  <action>
    Create directory `server/n8n-workflows/` if it does not exist (Phase 5 may not have persisted workflow files).

    Create `due-date-reminder-workflow.json` as a valid n8n workflow JSON that can be imported via n8n UI (Settings > Import Workflow). The workflow should contain these nodes:

    1. **Schedule Trigger** node:
       - Type: `n8n-nodes-base.scheduleTrigger`
       - Configured to run once daily at 8:00 AM (cron: `0 8 * * *`)
       - Set `active: false` by default so user must enable after configuring SMTP credentials

    2. **Fetch Overdue Requests** node:
       - Type: `n8n-nodes-base.httpRequest`
       - Method: GET
       - URL: `http://server:5000/api/v1/internal/pending-reminders?type=overdue`
       - Headers: `{ "x-api-key": "={{$env.INTERNAL_API_KEY}}" }` (placeholder -- user configures in n8n credential manager or env vars)
       - Response format: JSON

    3. **Fetch Upcoming Requests** node:
       - Type: `n8n-nodes-base.httpRequest`
       - Method: GET
       - URL: `http://server:5000/api/v1/internal/pending-reminders?type=upcoming`
       - Headers: `{ "x-api-key": "={{$env.INTERNAL_API_KEY}}" }`
       - Response format: JSON

    4. **Merge Results** node:
       - Type: `n8n-nodes-base.merge`
       - Combine overdue and upcoming reminders into a single list

    5. **Split Into Items** node:
       - Type: `n8n-nodes-base.splitInBatches` or `n8n-nodes-base.itemLists`
       - Split the reminders array so each reminder is processed individually

    6. **Send Reminder Email** node:
       - Type: `n8n-nodes-base.emailSend`
       - To: `={{ $json.assignedTo?.email || $json.createdBy?.email }}` (send to assignee if exists, else creator)
       - Subject: For overdue: `"[RMS] Overdue: {{ $json.title }} ({{ $json.daysOverdue }} days overdue)"`. For upcoming: `"[RMS] Due Soon: {{ $json.title }} (due {{ $json.dueDate }})"`
       - Body (HTML): Include request title, program ID, status, due date, days overdue/until due, and a link placeholder `http://YOUR_APP_URL/programs/{{ $json.programId }}/requests/{{ $json.requestId }}`
       - SMTP credentials: placeholder (user configures in n8n credential manager)

    7. **Create In-App Notification** node:
       - Type: `n8n-nodes-base.httpRequest`
       - Method: POST
       - URL: `http://server:5000/api/v1/internal/notifications`
       - Headers: `{ "x-api-key": "={{$env.INTERNAL_API_KEY}}", "Content-Type": "application/json" }`
       - Body: `{ "userId": "={{ $json.assignedTo?._id || $json.createdBy?._id }}", "type": "reminder", "title": "Due date reminder", "message": "Request '{{ $json.title }}' is {{ $json.daysOverdue > 0 ? $json.daysOverdue + ' days overdue' : 'due soon' }}", "programId": "={{ $json.programId }}", "requestId": "={{ $json.requestId }}" }`
       - NOTE: The notification `type` "reminder" must be added to the NOTIFICATION_TYPES array in `notification.model.ts` if it does not already exist. Check the model file and add it if missing.

    The workflow JSON should follow n8n's standard export format with:
    - `name: "Due Date Reminders"`
    - `active: false`
    - `nodes: [...]` array with all nodes
    - `connections: { ... }` object linking Schedule -> [Fetch Overdue, Fetch Upcoming] -> Merge -> Split -> Send Email -> Create Notification

    Also check `server/src/modules/notification/notification.model.ts` for NOTIFICATION_TYPES. If "reminder" is not included, add it to the array. This is a small model change that enables the n8n workflow to create reminder-type notifications.
  </action>
  <verify>
    Verify the JSON file is valid JSON via `node -e "JSON.parse(require('fs').readFileSync('server/n8n-workflows/due-date-reminder-workflow.json','utf8'))"`. Verify it contains Schedule Trigger, two HTTP Request nodes for pending-reminders, email send node, and notification creation node. If notification.model.ts was modified, run `cd server && npx tsc --noEmit`.
  </verify>
  <done>
    n8n workflow JSON template exists at `server/n8n-workflows/due-date-reminder-workflow.json`. The workflow is importable into n8n, runs on a daily schedule, fetches overdue and upcoming requests from the pending-reminders API, sends email reminders, and creates in-app notifications. The "reminder" notification type is available in the system.
  </done>
</task>

</tasks>

<verification>
- `server/n8n-workflows/due-date-reminder-workflow.json` is valid JSON
- Workflow contains Schedule Trigger, HTTP Request nodes for pending-reminders, email send, notification creation
- Workflow is set to `active: false` by default
- NOTIFICATION_TYPES includes "reminder" type
- Workflow calls the correct internal API endpoints with x-api-key header
</verification>

<success_criteria>
An importable n8n workflow exists that checks actual due dates (not staleness) and sends reminder notifications for upcoming and overdue requests. The workflow creates both email and in-app notifications.
</success_criteria>

<output>
After completion, create `.planning/phases/09-due-dates-reminders/09-03-SUMMARY.md`
</output>

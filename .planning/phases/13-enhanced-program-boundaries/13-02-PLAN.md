---
phase: 13-enhanced-program-boundaries
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - client/src/lib/types.ts
  - client/src/pages/ProgramListPage.tsx
  - client/src/pages/SheetViewPage.tsx
  - client/src/components/BoundaryStatsPanel.tsx
autonomous: true
requirements: [BOUND-01, BOUND-03]

must_haves:
  truths:
    - "Program cards on the program list page show boundary utilization indicators when limits are configured"
    - "Program management view shows per-user active request counts against their limits"
    - "Boundary indicators clearly display usage vs limits (e.g., 42/100 active requests)"
  artifacts:
    - path: "client/src/lib/types.ts"
      provides: "BoundaryStats type definition and updated Program settings type"
      contains: "maxActiveRequestsPerUser"
    - path: "client/src/components/BoundaryStatsPanel.tsx"
      provides: "Reusable boundary stats panel component"
      contains: "BoundaryStatsPanel"
    - path: "client/src/pages/ProgramListPage.tsx"
      provides: "Boundary utilization badges on program cards"
      contains: "maxActiveRequests"
    - path: "client/src/pages/SheetViewPage.tsx"
      provides: "Boundary stats panel accessible from sheet view header"
      contains: "BoundaryStatsPanel"
  key_links:
    - from: "client/src/components/BoundaryStatsPanel.tsx"
      to: "/api/v1/programs/:programId/boundary-stats"
      via: "api.get fetch on mount"
      pattern: "boundary-stats"
    - from: "client/src/pages/ProgramListPage.tsx"
      to: "client/src/lib/types.ts"
      via: "Program type with settings.maxActiveRequests"
      pattern: "maxActiveRequests"
---

<objective>
Add boundary utilization indicators to the frontend: show usage vs limits on program cards, and provide a detailed boundary stats panel accessible from the sheet view showing per-user breakdowns.

Purpose: Admins and managers need visibility into how close programs are to their boundary limits to proactively manage capacity. The program list shows at-a-glance indicators, while the sheet view provides a detailed per-user breakdown.

Output: Updated Program type with maxActiveRequestsPerUser, BoundaryStatsPanel component, boundary badges on ProgramListPage cards, and boundary stats button in SheetViewPage header.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-enhanced-program-boundaries/13-01-SUMMARY.md
@client/src/lib/types.ts
@client/src/pages/ProgramListPage.tsx
@client/src/pages/SheetViewPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types and create BoundaryStatsPanel component</name>
  <files>
    client/src/lib/types.ts
    client/src/components/BoundaryStatsPanel.tsx
  </files>
  <action>
1. In `client/src/lib/types.ts`:
   - Add `maxActiveRequestsPerUser?: number;` to the `settings` object in the `Program` interface, after `maxActiveRequests`
   - Add a new `BoundaryStats` interface:
     ```typescript
     export interface BoundaryStats {
       programId: string;
       programName: string;
       limits: {
         maxActiveRequests: number | null;
         maxActiveRequestsPerUser: number | null;
       };
       usage: {
         totalActiveRequests: number;
         perUser: Array<{
           userId: string;
           name: string;
           email: string | null;
           activeCount: number;
         }>;
       };
     }
     ```

2. Create `client/src/components/BoundaryStatsPanel.tsx`:
   - A component that takes `programId: string` and `userRole: string` props
   - Only renders for admin/manager roles (return null otherwise)
   - Fetches `GET /programs/${programId}/boundary-stats` via api.get on mount
   - Displays:
     a. **Program-wide limit section**: A horizontal bar showing `totalActiveRequests / maxActiveRequests` with color coding (green < 70%, orange 70-90%, red > 90%). If no maxActiveRequests configured, show "No program-wide limit set" in muted text.
     b. **Per-user limit section**: If maxActiveRequestsPerUser is configured, show a table/list of users with their active request count vs the per-user limit, using the same color coding. If no per-user limit configured, show "No per-user limit set" in muted text.
     c. **Per-user table columns**: User name, Email, Active Requests, Limit, Utilization bar
   - Use Tailwind div-based horizontal bars (same pattern as Phase 12 bar charts -- width percentage with min 2% for visibility)
   - Color coding: green `bg-green-500`, orange `bg-orange-500`, red `bg-red-500`
   - Bar width: `(count / limit * 100)%` with `min(100, ...)` cap
   - Loading state: show Skeleton placeholders
   - Error state: show inline error message
   - Style: Card-like container with padding, consistent with existing design system

Example structure:
```tsx
import { useState, useEffect } from 'react';
import api from '@/lib/api';
import type { BoundaryStats } from '@/lib/types';
import { Skeleton } from '@/components/ui/skeleton';

interface BoundaryStatsPanelProps {
  programId: string;
  userRole: string;
}

function getUtilizationColor(current: number, max: number): string {
  const pct = (current / max) * 100;
  if (pct >= 90) return 'bg-red-500';
  if (pct >= 70) return 'bg-orange-500';
  return 'bg-green-500';
}

export function BoundaryStatsPanel({ programId, userRole }: BoundaryStatsPanelProps) {
  // Only admin/manager can see boundary stats
  if (userRole !== 'admin' && userRole !== 'manager') return null;

  const [stats, setStats] = useState<BoundaryStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => { ... fetch logic ... }, [programId]);

  // Render program-wide usage bar + per-user table
}
```
  </action>
  <verify>
Run `cd client && npx tsc --noEmit` to verify TypeScript compiles. Verify BoundaryStatsPanel.tsx exists and exports the component.
  </verify>
  <done>
BoundaryStats type added. BoundaryStatsPanel component created with program-wide usage bar and per-user breakdown table. Color-coded utilization indicators. Admin/manager role guard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add boundary indicators to ProgramListPage and BoundaryStatsPanel to SheetViewPage</name>
  <files>
    client/src/pages/ProgramListPage.tsx
    client/src/pages/SheetViewPage.tsx
  </files>
  <action>
1. In `ProgramListPage.tsx`:
   - In the program card (inside the `CardContent` section, after the field count text), add boundary indicator badges when limits are configured:
     ```tsx
     {program.settings.maxActiveRequests !== undefined && program.settings.maxActiveRequests !== null && (
       <p className="text-xs text-muted-foreground mt-1">
         Max {program.settings.maxActiveRequests} active requests
       </p>
     )}
     {program.settings.maxActiveRequestsPerUser !== undefined && program.settings.maxActiveRequestsPerUser !== null && (
       <p className="text-xs text-muted-foreground">
         Max {program.settings.maxActiveRequestsPerUser} per user
       </p>
     )}
     ```
   - This is a lightweight indicator. The detailed stats are in the BoundaryStatsPanel (accessed from sheet view). Do NOT fetch boundary-stats API on the list page -- that would be N+1 queries. Just show the configured limit values from the program object that's already loaded.

2. In `SheetViewPage.tsx`:
   - Import `BoundaryStatsPanel` from `@/components/BoundaryStatsPanel`
   - Import `useAuth` (or get userRole from the auth context -- check how other pages access it, likely via `useAuth()` hook from `@/contexts/AuthContext`)
   - Add a state variable `showBoundaryStats` (boolean, default false)
   - In the page header area (near the Calendar button or SheetToolbar area), add a "Boundary Stats" button visible only to admin/manager:
     ```tsx
     {(userRole === 'admin' || userRole === 'manager') && (
       <button
         className="inline-flex items-center gap-1.5 rounded-md border border-input bg-background px-3 py-1.5 text-sm font-medium hover:bg-accent hover:text-accent-foreground"
         onClick={() => setShowBoundaryStats(!showBoundaryStats)}
       >
         Limits
       </button>
     )}
     ```
   - When `showBoundaryStats` is true, render BoundaryStatsPanel below the header and above the table:
     ```tsx
     {showBoundaryStats && (
       <div className="mb-4">
         <BoundaryStatsPanel programId={programId} userRole={userRole} />
       </div>
     )}
     ```
   - Check how the SheetViewPage currently gets `programId` -- it's likely from URL params via React Router. Also check how it gets the user role -- likely from auth context.
   - Read SheetViewPage.tsx FIRST to understand its current structure before making changes. Identify: where the header/toolbar is, how programId is obtained, how userRole is obtained.
  </action>
  <verify>
1. Run `cd client && npx tsc --noEmit` -- TypeScript compiles cleanly.
2. Grep ProgramListPage.tsx for "maxActiveRequests" to confirm boundary indicators are present.
3. Grep SheetViewPage.tsx for "BoundaryStatsPanel" to confirm it's imported and rendered.
  </verify>
  <done>
ProgramListPage cards show configured boundary limits (max active requests, max per user). SheetViewPage has a "Limits" button (admin/manager only) that toggles BoundaryStatsPanel showing live usage vs limits with per-user breakdown. All boundary indicators use color-coded utilization bars.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles in client: `cd client && npx tsc --noEmit` passes
2. Program type has maxActiveRequestsPerUser in settings
3. BoundaryStats type exists in types.ts
4. BoundaryStatsPanel component fetches and displays boundary stats
5. ProgramListPage cards show configured limit values
6. SheetViewPage has toggle button for BoundaryStatsPanel (admin/manager only)
7. BoundaryStatsPanel shows program-wide usage bar and per-user table
8. Color coding: green < 70%, orange 70-90%, red > 90%
</verification>

<success_criteria>
- Program cards on list page display configured boundary limits (when set)
- Sheet view has a "Limits" button for admin/manager that reveals BoundaryStatsPanel
- BoundaryStatsPanel shows program-wide active request count vs maxActiveRequests limit with utilization bar
- BoundaryStatsPanel shows per-user active request counts vs maxActiveRequestsPerUser limit
- Utilization bars are color-coded (green/orange/red) based on capacity percentage
- All components handle loading and error states gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/13-enhanced-program-boundaries/13-02-SUMMARY.md`
</output>
